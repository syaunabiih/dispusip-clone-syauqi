    <%- include('partials/header', { title: 'Daftar Buku', active: 'home' }) %>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css">
    <script src="https://cdn.jsdelivr.net/npm/sweetalert2@11"></script>
    <h1 class="text-2xl font-bold mb-6">üìö Daftar Buku</h1>


    <% if (typeof query !== 'undefined' && query.importSuccess) { %>
        <div class="alert-box mb-4 p-4 bg-green-100 text-green-700 rounded-lg border border-green-200 flex items-center shadow-sm">
            <i class="fas fa-check-circle mr-3 text-xl"></i>
            <div>
                <p class="font-bold">Import Selesai!</p>
                <p class="text-sm">
                    Berhasil menambahkan <b><%= query.importSuccess %></b> judul baru dan 
                    memperbarui <b><%= query.importExisting %></b> judul yang sudah ada.
                </p>
            </div>
        </div>
    <% } %>

    <% if (typeof query !== 'undefined' && query.deleteSuccess) { %>
        <div class="alert-box mb-4 p-4 bg-red-100 text-red-700 rounded-lg border border-red-200 flex items-center shadow-sm">
            <i class="fas fa-trash-alt mr-3 text-xl"></i>
            <p class="text-sm font-bold">Berhasil menghapus <%= query.deleteSuccess %> buku.</p>
        </div>
    <% } %>

    <% if (typeof query !== 'undefined' && query.updateSuccess) { %>
        <div class="alert-box mb-4 p-4 bg-green-100 text-green-700 rounded-lg border border-green-200 flex items-center shadow-sm">
            <i class="fas fa-check-circle mr-3 text-xl"></i>
            <p class="text-sm font-bold">Berhasil memperbarui data buku.</p>
        </div>
    <% } %>

    <% if (typeof query !== 'undefined' && query.addSuccess) { %>
        <div class="alert-box mb-4 p-4 bg-green-100 text-green-700 rounded-lg border border-green-200 flex items-center shadow-sm">
            <i class="fas fa-plus-circle mr-3 text-xl"></i>
            <p class="text-sm font-bold">Berhasil menambahkan buku baru ke dalam database.</p>
        </div>
    <% } %>

    <div class="mb-6 grid grid-cols-1 sm:grid-cols-2 gap-4 justify-center">

        <div class="bg-white rounded-xl shadow p-6 flex items-center gap-4">
            <div class="bg-blue-100 text-blue-600 p-3 rounded-full text-xl">
                üìö
            </div>
            <div>
                <p class="text-gray-500 text-sm">Total Judul</p>
                <p class="text-2xl font-bold">
                    <%= totalTitle || 0 %>
                </p>
            </div>
        </div>

        <div class="bg-white rounded-xl shadow p-6 flex items-center gap-4">
            <div class="bg-green-100 text-green-600 p-3 rounded-full text-xl">
                üìñ
            </div>
            <div>
                <p class="text-gray-500 text-sm">Total Buku</p>
                <p class="text-2xl font-bold">
                    <%= totalBook || 0 %>
                </p>
            </div>
        </div>

    </div>

    <div class="mb-4 flex flex-wrap gap-2 justify-start">
        <a href="/admin/books/export" class="inline-flex items-center px-3 py-2 sm:px-4 bg-green-600 text-white rounded-md font-semibold hover:bg-green-700 text-sm sm:text-base">
            <span class="hidden sm:inline">üìä </span>Export
        </a>

        <button onclick="toggleModal('importModal')" class="inline-flex items-center px-3 py-2 sm:px-4 bg-blue-600 text-white rounded-md font-semibold hover:bg-blue-700 text-sm sm:text-base">
            <span class="hidden sm:inline">üì• </span>Import
        </button>

        <a href="/admin/books/template" class="inline-flex items-center px-3 py-2 sm:px-4 bg-gray-600 text-white rounded-md font-semibold hover:bg-gray-700 text-sm sm:text-base">
            <span class="hidden sm:inline">üìÑ </span>Template
        </a>

        <button
            onclick="toggleIncompleteFilter()"
            id="btnFilterIncomplete"
            class="<%= query.incomplete ? 'bg-gray-700' : 'bg-orange-500' %> 
                    text-white px-3 py-2 sm:px-4 rounded-md font-bold text-xs sm:text-sm">
            <i class="fas fa-exclamation-circle mr-1 sm:mr-2"></i>
            <span class="hidden sm:inline"><%= query.incomplete ? 'Tampilkan Semua Data' : 'Tampilkan Data Tidak Lengkap' %></span>
            <span class="sm:hidden"><%= query.incomplete ? 'Semua' : 'Tidak Lengkap' %></span>
        </button>

        <button onclick="toggleDeleteMode()" id="btnDeleteMode" class="bg-red-100 text-red-600 px-3 py-2 sm:px-4 rounded-md font-bold hover:bg-red-200 border border-red-200 transition text-xs sm:text-sm">
            <i class="fas fa-edit mr-1 sm:mr-2"></i> <span class="hidden sm:inline">Mode Hapus Massal</span><span class="sm:hidden">Hapus</span>
        </button>

        <button id="btnSelectAllDatabase" onclick="selectAllDatabase()" class="hidden bg-orange-100 text-orange-600 px-3 py-2 sm:px-4 rounded-md font-bold hover:bg-orange-200 border border-orange-200 transition text-xs sm:text-sm">
            <i class="fas fa-database mr-1 sm:mr-2"></i> <span class="hidden sm:inline">Pilih Seluruh Data Buku (<%= totalTitle %>)</span><span class="sm:hidden">Pilih Semua</span>
        </button>
    </div>

    <div id="bulkActions" class="hidden mb-4 p-4 bg-red-600 text-white rounded-lg flex flex-col sm:flex-row justify-between items-stretch sm:items-center gap-3 shadow-lg">
        <span id="selectedCount" class="font-bold text-sm sm:text-base">0 buku dipilih</span>
        <button onclick="openDeleteModal()" class="bg-white text-red-600 px-4 py-2 rounded-md font-bold hover:bg-gray-100 transition whitespace-nowrap text-sm sm:text-base">
            üóëÔ∏è Hapus Sekarang
        </button>
    </div>

    <div id="importModal" class="fixed inset-0 z-50 hidden overflow-y-auto">
        <div class="flex items-center justify-center min-h-screen px-4">
            <div class="fixed inset-0 bg-gray-500 bg-opacity-75 transition-opacity"></div>

            <div class="bg-white rounded-lg overflow-hidden shadow-xl transform transition-all w-full max-w-lg mx-auto p-4 sm:p-6 relative">
                <h3 class="text-lg font-bold mb-4">Import Buku via Excel</h3>
                
                <form action="/admin/books/import" method="POST" enctype="multipart/form-data" id="importForm">
                    <div id="dropZone" class="border-2 border-dashed border-gray-300 rounded-lg p-10 text-center cursor-pointer hover:bg-gray-50 transition">
                        <p class="text-gray-600">Drag & drop file Excel di sini atau <b>Klik untuk memilih</b></p>
                        <input type="file" name="excelFile" id="fileInput" class="hidden" accept=".xlsx, .xls">
                        <p id="fileName" class="mt-2 text-blue-600 font-medium"></p>
                    </div>
                    
                    <div class="mt-6 flex justify-end gap-2">
                        <button type="button" onclick="toggleModal('importModal')" class="px-4 py-2 bg-gray-200 rounded-md">Batal</button>
                        <button type="submit" class="px-4 py-2 bg-blue-600 text-white rounded-md">Mulai Import</button>
                    </div>
                </form>
            </div>
        </div>
    </div>

    <div class="space-y-4 mb-8">
        <form action="/admin/books" method="GET">
            
            <div class="bg-white p-6 rounded-xl border border-gray-200 shadow-sm mb-4">
                <h2 class="text-lg font-bold text-gray-800 mb-4 flex items-center">
                    <i class="fas fa-search text-blue-600 mr-2"></i> Pencarian Buku
                </h2>
                <div class="flex flex-col md:flex-row gap-2">
                    <div class="flex-grow min-w-0">
                        <input type="text" name="q" value="<%= query.q || '' %>"
                            class="w-full p-2.5 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500 focus:border-blue-500 transition"
                            placeholder="Masukkan kata kunci pencarian...">
                    </div>

                    <div class="md:w-1/5 min-w-0">
                        <select name="searchBy" class="w-full p-2.5 bg-gray-50 border border-gray-300 rounded-lg">
                            <option value="title" <%= query.searchBy === 'title' ? 'selected' : '' %>>Judul</option>
                            <option value="author" <%= query.searchBy === 'author' ? 'selected' : '' %>>Pengarang</option>
                            <option value="publisher" <%= query.searchBy === 'publisher' ? 'selected' : '' %>>Penerbit</option>
                            <option value="subject" <%= query.searchBy === 'subject' ? 'selected' : '' %>>Subjek</option>
                        </select>
                    </div>

                    <div class="md:w-1/5 min-w-0">
                        <select name="matchType" class="w-full p-2.5 bg-gray-50 border border-gray-300 rounded-lg">
                            <option value="contains" <%= query.matchType === 'contains' ? 'selected' : '' %>>Salah Satu Isi</option>
                            <option value="startsWith" <%= query.matchType === 'startsWith' ? 'selected' : '' %>>Dimulai Dengan</option>
                            <option value="endsWith" <%= query.matchType === 'endsWith' ? 'selected' : '' %>>Diakhiri Dengan</option>
                            <option value="exact" <%= query.matchType === 'exact' ? 'selected' : '' %>>Tepat (Exact)</option>
                        </select>
                    </div>

                    <div class="min-w-0">
                        <button type="submit" class="bg-blue-600 hover:bg-blue-700 text-white px-8 py-2.5 rounded-lg font-bold w-full md:w-auto transition shadow-sm">
                            Cari
                        </button>
                    </div>
                </div>
                <div class="mt-3 flex justify-between items-center">
                    <div class="flex gap-4 text-xs text-gray-500">
                        <a href="/admin/books" class="hover:text-blue-600 transition"><i class="fas fa-undo mr-1"></i> Reset Pencarian</a>
                    </div>
                    <% if (query.q || query.category || query.subject || query.year) { %>
                        <span class="text-[10px] bg-blue-200 text-blue-800 px-2 py-0.5 rounded-full font-bold uppercase">Filter Aktif</span>
                    <% } %>
                </div>
            </div>

            <div class="bg-white p-4 sm:p-5 rounded-xl border border-blue-100 shadow-sm">
                <div class="flex items-center mb-3">
                    <i class="fas fa-sliders-h text-blue-600 mr-2 text-sm"></i>
                    <span class="text-xs sm:text-sm font-bold text-gray-700 uppercase tracking-wider">Filter Data</span>
                </div>
                
                <div class="grid grid-cols-1 md:grid-cols-4 gap-3">
                    <div class="min-w-0">
                        <select name="category" id="categoryAdminSelect" class="w-full p-2 sm:p-2.5 bg-gray-50 border border-gray-300 rounded-lg text-sm">
                            <option value="">Semua Kategori</option>
                            <% allCategories.forEach(item => { %>
                                <option value="<%= item.id %>" <%= query.category == item.id ? 'selected' : '' %>><%= item.name %></option>
                            <% }) %>
                        </select>
                    </div>

                    <div class="min-w-0">
                        <select name="subject" id="subjectAdminSelect" class="w-full p-2 sm:p-2.5 bg-gray-50 border border-gray-300 rounded-lg text-sm">
                            <option value="">Semua Subjek</option>
                            <% allSubjects.forEach(item => { %>
                                <option value="<%= item.id %>" <%= query.subject == item.id ? 'selected' : '' %>><%= item.name %></option>
                            <% }) %>
                        </select>
                    </div>

                    <div class="min-w-0">
                        <select name="year" id="yearAdminSelect" class="w-full p-2 sm:p-2.5 bg-gray-50 border border-gray-300 rounded-lg text-sm">
                            <option value="">Semua Tahun</option>
                            <% allYears.forEach(y => { %>
                                <option value="<%= y %>" <%= query.year == y ? 'selected' : '' %>><%= y %></option>
                            <% }) %>
                        </select>
                    </div>

                    <div class="min-w-0">
                        <button type="submit" class="w-full bg-blue-600 hover:bg-blue-700 text-white px-4 sm:px-8 py-2 sm:py-2.5 rounded-lg font-bold transition flex items-center justify-center gap-2 text-sm sm:text-base">
                            <i class="fas fa-filter text-xs"></i> <span class="hidden sm:inline">Terapkan Filter</span><span class="sm:hidden">Filter</span>
                        </button>
                    </div>
                </div>
            </div>
        </form>
    </div>

    <!-- Mobile Card View -->
    <div class="block md:hidden space-y-4">
        <% if (books.length === 0) { %>
            <div class="p-4 text-center text-gray-500 bg-white rounded-lg shadow">Belum ada buku.</div>
        <% } else { %>
            <% books.forEach((book, index) => { 
                const hasCategory = !!book.Category;
                const hasSubjects = book.Subjects && book.Subjects.length > 0;
                const hasShelf = !!book.shelf_location && book.shelf_location.trim() !== "" && book.shelf_location !== "-";
                const hasCopies = book.copies && book.copies.length > 0;
                const hasIsbn = !!book.isbn && book.isbn.trim() !== "";
                const hasCallNumber = !!book.call_number && book.call_number.trim() !== "";
                const hasAuthors = book.Authors && book.Authors.some(ba => ba.BookAuthor && ba.BookAuthor.role === 'penulis');
                const hasPublishers = book.Publishers && book.Publishers.length > 0;
                const bookStatusIncomplete = !hasCategory || !hasSubjects || !hasCopies || !hasCallNumber || !hasAuthors || !hasPublishers;
            %>
            <div class="bg-white rounded-lg shadow-md overflow-hidden border border-gray-200 book-row <%= bookStatusIncomplete ? 'is-incomplete' : '' %>">
                <div class="p-4 flex gap-4">
                    <!-- Gambar Buku -->
                    <div class="flex-shrink-0">
                        <div class="w-20 h-28 border border-gray-200 bg-gray-50 flex items-center justify-center overflow-hidden rounded">
                            <% if (book.image) { %>
                                <img src="/image/uploads/<%= book.image %>" alt="<%= book.title %>" class="w-full h-full object-cover">
                            <% } else { %>
                                <div class="text-center text-gray-400 text-[10px] font-bold p-2">NO COVER</div>
                            <% } %>
                        </div>
                    </div>
                    
                    <!-- Informasi Buku -->
                    <div class="flex-grow min-w-0">
                        <div class="flex items-start justify-between mb-2">
                            <div class="flex-grow min-w-0">
                                <div class="font-semibold text-gray-800 text-sm mb-1 line-clamp-2"><%= book.title %></div>
                                <div class="text-xs text-gray-500 mb-2">
                                    <%= book.Category ? book.Category.name : 'Tanpa Kategori' %>
                                </div>
                            </div>
                            <div class="flex-shrink-0 ml-2">
                                <input type="checkbox" name="bookIds" value="<%= book.id %>" class="delete-checkbox hidden cursor-pointer" onchange="updateBulkPanel()">
                                <span class="text-xs text-gray-400">#<%= (currentPage - 1) * limit + index + 1 %></span>
                            </div>
                        </div>
                        
                        <!-- Status -->
                        <div class="mb-3">
                            <% if (bookStatusIncomplete) { %>
                                <span class="bg-yellow-400 text-white text-[10px] px-2 py-1 rounded font-bold uppercase inline-block">
                                    Data Tidak Lengkap
                                </span>
                            <% } else { %>
                                <span class="text-green-500 font-bold text-xs"><i class="fas fa-check-circle"></i> Lengkap</span>
                            <% } %>
                        </div>
                        
                        <!-- Tombol Aksi -->
                        <div class="flex gap-2">
                            <a href="/admin/books/edit/<%= book.id %>?origin_q=<%= query.q || '' %>&origin_searchBy=<%= query.searchBy || 'title' %>&origin_matchType=<%= query.matchType || 'contains' %>&origin_category=<%= query.category || '' %>&origin_subject=<%= query.subject || '' %>&origin_year=<%= query.year || '' %>&origin_page=<%= currentPage %>" 
                                class="bg-blue-500 hover:bg-blue-600 text-white px-3 py-1.5 rounded text-xs font-medium flex items-center gap-1 transition flex-1 justify-center">
                                <i class="fas fa-edit"></i> Edit
                            </a>
                            
                            <button type="button" 
                                    class="btn-hapus-cepat bg-red-500 hover:bg-red-600 text-white px-3 py-1.5 rounded text-xs font-medium flex items-center gap-1 transition flex-1 justify-center"
                                    data-id="<%= book.id %>"
                                    data-title="<%= book.title %>"
                                    data-q="<%= query.q || '' %>"
                                    data-page="<%= currentPage %>">
                                <i class="fas fa-trash"></i> Hapus
                            </button>
                        </div>
                    </div>
                </div>
            </div>
            <% }) %>
        <% } %>
    </div>

    <!-- Desktop Table View -->
    <div class="hidden md:block overflow-x-auto">
    <table class="min-w-full bg-white rounded-lg shadow overflow-hidden">
        <thead class="bg-gray-100 text-left">
            <tr>
                <th class="p-2 sm:p-4 w-16">No</th>
                <th class="p-2 sm:p-4 w-24">Gambar</th>
                <th class="p-2 sm:p-4">Judul</th>
                <th class="p-2 sm:p-4 w-38 text-center">Status Data</th>
                <th class="p-2 sm:p-4 w-38 text-center">Kategori</th>
                <th class="p-2 sm:p-4 w-32 text-center">Aksi</th>
            </tr>
        </thead>
        <tbody>
            <% if (books.length === 0) { %>
                <tr><td colspan="6" class="p-4 text-center text-gray-500">Belum ada buku.</td></tr>
            <% } else { %>
                <% books.forEach((book, index) => { 
                    const hasCategory = !!book.Category;
                    const hasSubjects = book.Subjects && book.Subjects.length > 0;
                    const hasShelf = !!book.shelf_location && book.shelf_location.trim() !== "" && book.shelf_location !== "-";
                    const hasCopies = book.copies && book.copies.length > 0;
                    const hasIsbn = !!book.isbn && book.isbn.trim() !== "";
                    const hasCallNumber = !!book.call_number && book.call_number.trim() !== "";
                    const hasAuthors = book.Authors && book.Authors.some(ba => ba.BookAuthor && ba.BookAuthor.role === 'penulis');
                    const hasPublishers = book.Publishers && book.Publishers.length > 0;
                    const bookStatusIncomplete = !hasCategory || !hasSubjects || !hasCopies || !hasCallNumber || !hasAuthors || !hasPublishers;
                %>
                <tr class="border-t hover:bg-gray-50 book-row <%= bookStatusIncomplete ? 'is-incomplete' : '' %>">
                    <td class="p-2 sm:p-4">
                        <input type="checkbox" name="bookIds" value="<%= book.id %>" class="delete-checkbox hidden cursor-pointer" onchange="updateBulkPanel()">
                        <span><%= (currentPage - 1) * limit + index + 1 %></span>
                    </td>
                    <td class="p-2 sm:p-4">
                        <div class="w-12 h-16 border border-gray-200 bg-gray-50 flex items-center justify-center overflow-hidden mx-auto rounded">
                            <% if (book.image) { %>
                                <img src="/image/uploads/<%= book.image %>" alt="<%= book.title %>" class="w-full h-full object-cover">
                            <% } else { %>
                                <div class="text-center text-gray-400 text-[8px] font-bold">NO COVER</div>
                            <% } %>
                        </div>
                    </td>
                    <td class="p-2 sm:p-4 font-medium">
                        <div class="font-semibold text-gray-800"><%= book.title %></div>
                    </td>
                    
                    <td class="p-2 sm:p-4 text-sm text-center"> 
                        <% if (bookStatusIncomplete) { %>
                            <span class="bg-yellow-400 text-white text-[10px] px-2 py-1 rounded font-bold uppercase whitespace-nowrap shadow-sm">
                                Data Required Tidak Lengkap
                            </span>
                        <% } else { %>
                            <span class="text-green-500 font-bold text-xs"><i class="fas fa-check-circle"></i> Lengkap</span>
                        <% } %>
                    </td>

                    <td class="p-2 sm:p-4 text-sm text-gray-600">
                        <%= book.Category ? book.Category.name : '-' %>
                    </td>
                    
                    <td class="p-2 sm:p-4 text-center">
                        <div class="flex justify-center gap-2">
                            <a href="/admin/books/edit/<%= book.id %>?origin_q=<%= query.q || '' %>&origin_searchBy=<%= query.searchBy || 'title' %>&origin_matchType=<%= query.matchType || 'contains' %>&origin_category=<%= query.category || '' %>&origin_subject=<%= query.subject || '' %>&origin_year=<%= query.year || '' %>&origin_page=<%= currentPage %>" 
                                class="bg-blue-500 hover:bg-blue-600 text-white w-9 h-9 rounded shadow flex items-center justify-center transition" title="Edit">
                                <i class="fas fa-edit"></i>
                            </a>
                            
                            <button type="button" 
                                    class="btn-hapus-cepat bg-red-500 hover:bg-red-600 text-white w-9 h-9 rounded shadow flex items-center justify-center transition"
                                    data-id="<%= book.id %>"
                                    data-title="<%= book.title %>"
                                    data-q="<%= query.q || '' %>"
                                    data-page="<%= currentPage %>">
                                <i class="fas fa-trash"></i>
                            </button>
                        </div>
                    </td>
                </tr>
                <% }) %>
            <% } %>
        </tbody>
    </table>
    </div>

    <div id="deleteModal" class="fixed inset-0 z-[80] hidden overflow-y-auto">
        <div class="flex items-center justify-center min-h-screen px-4 text-center">
            <div class="fixed inset-0 bg-black opacity-60" onclick="toggleModal('deleteModal')"></div>
            <div class="inline-block align-bottom bg-white rounded-xl text-left overflow-hidden shadow-2xl transform transition-all w-full max-w-lg mx-auto p-4 sm:p-6 relative">
                <div class="text-center">
                    <i class="fas fa-exclamation-triangle text-red-500 text-5xl mb-4"></i>
                    <h3 id="deleteModalTitle" class="text-xl font-bold text-gray-900 mb-2">Konfirmasi Hapus</h3>
                    <p id="deleteModalDesc" class="text-gray-500 mb-6 text-sm font-medium">Tindakan ini tidak bisa dibatalkan.</p>
                    <p class="text-xs font-bold text-red-600 uppercase tracking-widest mb-2">Ketik kalimat di bawah ini:</p>
                    <p id="textToType" class="font-mono bg-gray-100 p-3 rounded-lg mb-4 text-red-600 font-bold text-lg select-none shadow-inner border border-gray-200">HAPUS DATA</p>
                    <input type="text" id="confirmInput" class="w-full border-2 border-gray-300 p-3 rounded-xl focus:border-red-500 outline-none text-center" placeholder="Ketik di sini...">
                </div>
                <div class="mt-8 flex justify-center gap-3">
                    <button type="button" onclick="toggleModal('deleteModal')" class="px-6 py-2.5 bg-gray-100 text-gray-700 rounded-lg font-bold hover:bg-gray-200 transition">Batal</button>
                    <button id="btnFinalDelete" disabled class="px-8 py-2.5 bg-red-600 text-white rounded-lg font-bold opacity-50 cursor-not-allowed transition hover:bg-red-700">Hapus Selamanya</button>
                </div>
            </div>
        </div>
    </div>

            <%
            const qs = new URLSearchParams({
                q: query.q || '',
                searchBy: query.searchBy || 'title',
                matchType: query.matchType || 'contains',
                category: query.category || '',
                subject: query.subject || '',
                year: query.year || '',
                incomplete: query.incomplete || ''
            }).toString();
            %>

            <% if (totalPages > 1) { %>
                <div class="mt-8 flex flex-wrap justify-center items-center gap-1">
                        <% if (currentPage > 1) { %>
                            <a href="/admin/books?<%= qs %>&page=<%= currentPage - 1 %>"
                                class="px-3 py-1 border rounded text-sm bg-white text-gray-600 hover:bg-blue-50">
                                <i class="fas fa-chevron-left"></i>
                            </a>
                        <% } %>

                        <% 
                            let delta = 2; // Menampilkan 2 halaman di kiri dan 2 di kanan active page
                            let left = parseInt(currentPage) - delta;
                            let right = parseInt(currentPage) + delta;
                            let range = [];
                            let rangeWithDots = [];
                            let l;

                            for (let i = 1; i <= totalPages; i++) {
                                if (i == 1 || i == totalPages || (i >= left && i <= right)) {
                                    range.push(i);
                                }
                            }

                            for (let i of range) {
                                if (l) {
                                    if (i - l === 2) {
                                        rangeWithDots.push(l + 1);
                                    } else if (i - l !== 1) {
                                        rangeWithDots.push('...');
                                    }
                                }
                                rangeWithDots.push(i);
                                l = i;
                            }
                        %>

                        <% rangeWithDots.forEach(i => { %>
                            <% if (i === '...') { %>
                                <span class="px-3 py-1 text-gray-400">...</span>
                            <% } else { %>
                                <a href="/admin/books?<%= qs %>&page=<%= i %>"
                                    class="px-3 py-1 border rounded text-sm transition-colors
                                    <%= currentPage == i
                                        ? 'bg-blue-600 text-white border-blue-600 font-bold'
                                        : 'bg-white text-gray-600 hover:bg-blue-50' %>">
                                    <%= i %>
                                </a>
                            <% } %>
                        <% }) %>

                        <% if (currentPage < totalPages) { %>
                            <a href="/admin/books?<%= qs %>&page=<%= currentPage + 1 %>"
                                class="px-3 py-1 border rounded text-sm bg-white text-gray-600 hover:bg-blue-50">
                                <i class="fas fa-chevron-right"></i>
                            </a>
                        <% } %>

                    </div>
                <% } %>

    <script>
        // Inisialisasi variabel global
        let isAllDatabaseSelected = false; 
        let excludedIds = []; 
        const totalRecords = parseInt('<%= totalTitle %>') || 0; // Cara aman agar editor tidak merah

        // 1. Fungsi Pilih Semua Data (Lintas Halaman)
        function selectAllDatabase() {
            const checkboxes = document.querySelectorAll('.delete-checkbox');
            const btnAll = document.getElementById('btnSelectAllDatabase');
            
            if (!isAllDatabaseSelected) {
                isAllDatabaseSelected = true;
                excludedIds = []; 
                checkboxes.forEach(cb => cb.checked = true);
                
                btnAll.setAttribute('data-all', 'true');
                btnAll.innerHTML = '<i class="fas fa-times mr-2"></i> Batalkan Pilihan Semua';
                btnAll.classList.replace('bg-orange-100', 'bg-gray-800');
                btnAll.classList.replace('text-orange-600', 'text-white');
            } else {
                isAllDatabaseSelected = false;
                excludedIds = [];
                checkboxes.forEach(cb => cb.checked = false);
                
                btnAll.setAttribute('data-all', 'false');
                btnAll.innerHTML = `<i class="fas fa-database mr-2"></i> Pilih Seluruh Data Buku (${totalRecords})`;
                btnAll.classList.replace('bg-gray-800', 'bg-orange-100');
                btnAll.classList.replace('text-white', 'text-orange-600');
            }
            updateBulkPanel();
        }

        // 2. Listener untuk memantau Uncheck saat mode "Pilih Semua" aktif
        document.addEventListener('change', function(e) {
            if (e.target.classList.contains('delete-checkbox')) {
                const bookId = e.target.value;
                if (isAllDatabaseSelected) {
                    if (!e.target.checked) {
                        if (!excludedIds.includes(bookId)) excludedIds.push(bookId);
                    } else {
                        excludedIds = excludedIds.filter(id => id !== bookId);
                    }
                }
                updateBulkPanel();
            }
        });

        // 3. Fungsi Update Panel Hitungan
        function updateBulkPanel() {
            const checkedCheckboxes = document.querySelectorAll('input[name="bookIds"]:checked');
            const panel = document.getElementById('bulkActions');
            const label = document.getElementById('selectedCount');
            
            let totalSelected = 0;
            if (isAllDatabaseSelected) {
                totalSelected = totalRecords - excludedIds.length;
            } else {
                totalSelected = checkedCheckboxes.length;
            }

            if (totalSelected > 0) {
                panel.classList.remove('hidden');
                label.innerText = totalSelected + ' buku dipilih';
            } else {
                panel.classList.add('hidden');
            }
        }

        // 4. Fungsi Submit Hapus (Satu fungsi untuk semua kondisi)
        function submitFormHapus(confirmText, originQ = '', originPage = '1') {
            const form = document.createElement('form');
            form.method = 'POST';
            form.action = '/admin/books/delete-multiple';

            const urlParams = new URLSearchParams(window.location.search);
            const filterKeys = ['q', 'searchBy', 'matchType', 'category', 'subject', 'year', 'incomplete'];
            
            filterKeys.forEach(key => {
                const val = urlParams.get(key);
                // Tambahkan pengecekan: hanya buat input jika value tidak null
                if (val !== null) { 
                    const input = document.createElement('input');
                    input.type = 'hidden';
                    input.name = key;
                    input.value = val;
                    form.appendChild(input);
                }
            });

            // Kirim kalimat konfirmasi
            const conf = document.createElement('input');
            conf.type = 'hidden'; conf.name = 'confirmation'; conf.value = confirmText;
            form.appendChild(conf);

            if (isAllDatabaseSelected) {
                const allInput = document.createElement('input');
                allInput.type = 'hidden'; allInput.name = 'deleteAll'; allInput.value = 'true';
                form.appendChild(allInput);

                excludedIds.forEach(id => {
                    const input = document.createElement('input');
                    input.type = 'hidden'; input.name = 'excludeIds'; input.value = id;
                    form.appendChild(input);
                });
            } else {
                const selectedIds = Array.from(document.querySelectorAll('input[name="bookIds"]:checked')).map(cb => cb.value);
                if (selectedIds.length === 0) return;
                selectedIds.forEach(id => {
                    const input = document.createElement('input');
                    input.type = 'hidden'; input.name = 'bookIds'; input.value = id;
                    form.appendChild(input);
                });
            }

            // Hindari duplikasi q jika sudah ada di loop filterKeys di atas
            if (!urlParams.has('q')) {
                const qInput = document.createElement('input');
                qInput.type = 'hidden'; qInput.name = 'q'; qInput.value = originQ;
                form.appendChild(qInput);
            }

            const pageInput = document.createElement('input');
            pageInput.type = 'hidden'; pageInput.name = 'page'; pageInput.value = originPage;
            form.appendChild(pageInput);

            document.body.appendChild(form);
            form.submit();
        }

        // 5. Event Listener untuk tombol Hapus Cepat (Tong Sampah di baris tabel)
        document.addEventListener('click', function(e) {
            const btn = e.target.closest('.btn-hapus-cepat');
            if (btn) {
                const bookId = btn.getAttribute('data-id');
                const bookTitle = btn.getAttribute('data-title');
                const originQ = btn.getAttribute('data-q');
                const originPage = btn.getAttribute('data-page');

                document.querySelectorAll('.delete-checkbox').forEach(cb => cb.checked = false);
                const myCheckbox = document.querySelector(`input[name="bookIds"][value="${bookId}"]`);
                if (myCheckbox) myCheckbox.checked = true;

                Swal.fire({
                    title: 'Hapus Buku?',
                    html: `Yakin ingin menghapus buku <b>"${bookTitle}"</b>?`,
                    icon: 'warning',
                    showCancelButton: true,
                    confirmButtonColor: '#ef4444',
                    confirmButtonText: 'Ya, Hapus!',
                    cancelButtonText: 'Batal',
                    reverseButtons: true
                }).then((result) => {
                    if (result.isConfirmed) {
                        submitFormHapus('HAPUS DATA', originQ, originPage);
                    } else {
                        if (myCheckbox) myCheckbox.checked = false;
                        updateBulkPanel();
                    }
                });
            }
        });

        // 6. Fungsi UI lainnya
        function toggleDeleteMode() {
            const checkboxes = document.querySelectorAll('.delete-checkbox');
            const btn = document.getElementById('btnDeleteMode');
            const btnSelectAll = document.getElementById('btnSelectAllDatabase');

            checkboxes.forEach(cb => cb.classList.toggle('hidden'));
            
            if (btn.classList.contains('bg-red-100')) {
                btn.classList.replace('bg-red-100', 'bg-red-600'); 
                btn.classList.replace('text-red-600', 'text-white');
                btnSelectAll.classList.remove('hidden');
            } else {
                btn.classList.replace('bg-red-600', 'bg-red-100'); 
                btn.classList.replace('text-white', 'text-red-600');
                btnSelectAll.classList.add('hidden');
                
                isAllDatabaseSelected = false;
                excludedIds = [];
                btnSelectAll.setAttribute('data-all', 'false');
                btnSelectAll.innerHTML = `<i class="fas fa-database mr-2"></i> Pilih Seluruh Data Buku (${totalRecords})`;
                
                document.querySelectorAll('.delete-checkbox').forEach(c => c.checked = false);
                updateBulkPanel();
            }
        }

        function toggleIncompleteFilter() {
            const url = new URL(window.location.href);
            const isActive = url.searchParams.get('incomplete') === '1';

            if (isActive) {
                url.searchParams.delete('incomplete');
            } else {
                url.searchParams.set('incomplete', '1');
            }

            url.searchParams.delete('page'); // reset ke halaman 1
            window.location.href = url.toString();
        }

        function toggleModal(id) {
            const m = document.getElementById(id);
            if(m) m.classList.toggle('hidden');
        }

        function openDeleteModal() {
            toggleModal('deleteModal');
        }

        // Input Konfirmasi Ketik
        const confirmInput = document.getElementById('confirmInput');
        if(confirmInput){
            confirmInput.addEventListener('input', function(e) {
                const btn = document.getElementById('btnFinalDelete');
                const target = document.getElementById('textToType').innerText;
                const isMatch = e.target.value === target;
                btn.disabled = !isMatch;
                btn.classList.toggle('opacity-50', !isMatch);
                btn.classList.toggle('cursor-not-allowed', !isMatch);
            });
        }

        const btnFinalDelete = document.getElementById('btnFinalDelete');
        if(btnFinalDelete){
            btnFinalDelete.onclick = function() {
                submitFormHapus('HAPUS DATA');
            };
        }

        document.addEventListener('DOMContentLoaded', function() {
            const alerts = document.querySelectorAll('.alert-box');
            alerts.forEach(alert => {
                setTimeout(() => {
                    alert.style.transition = "opacity 0.6s ease";
                    alert.style.opacity = "0";
                    setTimeout(() => alert.remove(), 600);
                }, 2000);
            });
        });

        const dropZone = document.getElementById('dropZone');
        const fileInput = document.getElementById('fileInput');
        const fileNameDisplay = document.getElementById('fileName');

        if(dropZone) {
            // 1. Klik untuk pilih file
            dropZone.onclick = () => fileInput.click();

            // 2. Saat file dipilih via dialog
            fileInput.onchange = () => { 
                if(fileInput.files.length) fileNameDisplay.innerText = "File terpilih: " + fileInput.files[0].name; 
            };

            // 3. Logika Drag & Drop
            // Mencegah browser membuka file saat di-drop
            ['dragenter', 'dragover', 'dragleave', 'drop'].forEach(eventName => {
                dropZone.addEventListener(eventName, (e) => {
                    e.preventDefault();
                    e.stopPropagation();
                }, false);
            });

            // Efek visual saat file ditarik di atas box
            ['dragenter', 'dragover'].forEach(eventName => {
                dropZone.addEventListener(eventName, () => {
                    dropZone.classList.add('bg-blue-50', 'border-blue-500');
                }, false);
            });

            ['dragleave', 'drop'].forEach(eventName => {
                dropZone.addEventListener(eventName, () => {
                    dropZone.classList.remove('bg-blue-50', 'border-blue-500');
                }, false);
            });

            // Saat file dilepas (Drop)
            dropZone.addEventListener('drop', (e) => {
                const dt = e.dataTransfer;
                const files = dt.files;

                if (files.length > 0) {
                    fileInput.files = files; // Masukkan file ke dalam input
                    fileNameDisplay.innerText = "File terpilih: " + files[0].name;
                }
            }, false);
        }

        const importForm = document.getElementById('importForm');

        if (importForm) {
            importForm.onsubmit = function(e) {
                if (!fileInput.files.length) {
                    e.preventDefault();
                    Swal.fire({ icon: 'error', title: 'Gagal', text: 'Pilih file dulu!' });
                    return false;
                }
                
                Swal.fire({
                    title: 'Memproses Data Excel',
                    html: 'Sistem sedang mengimport data...<br><b>Mohon tidak menutup tab ini.</b>',
                    allowOutsideClick: false,
                    allowEscapeKey: false,
                    didOpen: () => {
                        Swal.showLoading();
                    }
                });

                return true;
            };
        }
    </script>
    <%- include('partials/footer') %>