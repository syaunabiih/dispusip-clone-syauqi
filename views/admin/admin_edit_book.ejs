<%- include('partials/header', { title: 'Edit Buku', active: 'home' }) %>

<link href="https://cdn.jsdelivr.net/npm/tom-select/dist/css/tom-select.css" rel="stylesheet">
<script src="https://cdn.jsdelivr.net/npm/tom-select/dist/js/tom-select.complete.min.js"></script>

<h1 class="text-2xl font-bold mb-6">✏️ Edit Buku</h1>

<form 
    action="/admin/books/edit/<%= book.id %>" 
    method="POST" 
    enctype="multipart/form-data"
    class="bg-white p-6 rounded-lg shadow space-y-6"
>

<!-- ================= INFORMASI DASAR ================= -->
<div class="grid grid-cols-2 gap-6">
    <div class="space-y-4">
        <div>
            <label class="font-medium">Judul</label>
            <input type="text" name="title" value="<%= book.title %>" required class="w-full p-2 border rounded">
        </div>

        <div>
            <label class="font-medium">Edisi</label>
            <input type="text" name="edition" value="<%= book.edition %>" class="w-full p-2 border rounded">
        </div>

        <div>
            <label class="font-medium">Tahun Terbit</label>
            <input type="text" name="publish_year" maxlength="4" value="<%= book.publish_year %>" class="w-full p-2 border rounded">
        </div>

        <div>
            <label class="font-medium">Tempat Terbit</label>
            <input type="text" name="publish_place" value="<%= book.publish_place %>" class="w-full p-2 border rounded">
        </div>
    </div>

    <div class="space-y-4">
        <div>
            <label class="font-medium">Deskripsi Fisik</label>
            <input type="text" name="physical_description" value="<%= book.physical_description %>" class="w-full p-2 border rounded">
        </div>

        <div>
            <label class="font-medium">ISBN</label>
            <input type="text" name="isbn" value="<%= book.isbn %>" class="w-full p-2 border rounded">
        </div>

        <div>
            <label class="font-medium">Call Number</label>
            <input type="text" name="call_number" value="<%= book.call_number %>" class="w-full p-2 border rounded">
        </div>
    </div>
</div>

<!-- ================= ABSTRAK & CATATAN ================= -->
<div>
    <label class="font-medium">Abstrak</label>
    <textarea name="abstract" rows="4" class="w-full p-2 border rounded"><%= book.abstract %></textarea>
</div>

<div>
    <label class="font-medium">Catatan</label>
    <textarea name="notes" rows="3" class="w-full p-2 border rounded"><%= book.notes %></textarea>
</div>

<!-- ================= AUTHOR & PUBLISHER ================= -->
<div class="grid grid-cols-2 gap-6">
    <div>
        <label class="font-medium">Penulis</label>
        <select name="authors[]" id="author-select" class="w-full p-2 border rounded" multiple>
            <% authors.forEach(a => { %>
                <option value="<%= a.id %>" <%= book.Authors.some(b => b.id === a.id) ? 'selected' : '' %>>
                    <%= a.name %>
                </option>
            <% }) %>
        </select>
    </div>

    <div>
        <label class="font-medium">Penerbit</label>
        <select name="publishers[]" id="publisher-select" class="w-full p-2 border rounded" multiple>
            <% publishers.forEach(p => { %>
                <option value="<%= p.id %>" <%= book.Publishers.some(b => b.id === p.id) ? 'selected' : '' %>>
                    <%= p.name %>
                </option>
            <% }) %>
        </select>
    </div>
</div>

<!-- ================= KATEGORI & SUBJEK ================= -->
<div class="grid grid-cols-2 gap-6">
    <div>
        <label class="font-medium">Kategori</label>
        <select name="category_id" id="category-select" class="w-full p-2 border rounded">
            <% categories.forEach(c => { %>
                <option value="<%= c.id %>" <%= book.Category?.id === c.id ? 'selected' : '' %>>
                    <%= c.name %>
                </option>
            <% }) %>
        </select>
    </div>

    <div>
        <label class="font-medium">Subjek</label>
        <select name="subjects[]" id="subject-select" class="w-full p-2 border rounded" multiple>
            <% subjects.forEach(s => { %>
                <option value="<%= s.id %>" <%= book.Subjects.some(bs => bs.id === s.id) ? 'selected' : '' %>>
                    <%= s.name %>
                </option>
            <% }) %>
        </select>
    </div>
</div>

<!-- ================= INFORMASI LAIN ================= -->
<div class="grid grid-cols-2 gap-6">
    <div>
        <label class="font-medium">Bahasa</label>
        <input type="text" name="language" value="<%= book.language %>" class="w-full p-2 border rounded">
    </div>

    <div>
        <label class="font-medium">Lokasi Rak</label>
        <input type="text" name="shelf_location" value="<%= book.shelf_location %>" class="w-full p-2 border rounded">
    </div>
</div>

<!-- ================= NO INDUK (EKSEMPLAR FISIK) ================= -->
<div class="mt-4">
    <label class="font-medium text-blue-700">Nomor Induk Fisik Buku</label>

    <textarea 
        name="no_induk"
        rows="4"
        class="w-full p-2 border-2 border-blue-200 rounded focus:border-blue-500 outline-none"
    ><%= book.copies?.map(c => c.no_induk).join('\n') %></textarea>

    <p class="text-sm text-gray-500 mt-1 italic">
        *Satu nomor induk = satu eksemplar fisik buku.  
        Stok akan dihitung otomatis dari jumlah nomor induk.
    </p>
</div>

<!-- ================= COVER ================= -->
<div>
    <label class="font-medium">Cover Buku</label>

    <% if (book.image) { %>
        <div id="existing-cover" class="flex items-center gap-3 mt-2">
            <span class="px-3 py-1 bg-gray-200 rounded text-sm">
                <%= book.image %>
            </span>
            <button 
                type="button" 
                id="remove-cover"
                class="text-red-600 font-bold hover:text-red-800"
                title="Hapus / ganti cover"
            >
                ✖
            </button>
        </div>

        <input 
            type="file" 
            name="image" 
            id="cover-input"
            accept="image/*" 
            class="w-full p-2 border rounded mt-2 hidden"
        >
    <% } else { %>
        <input 
            type="file" 
            name="image" 
            accept="image/*" 
            class="w-full p-2 border rounded mt-2"
        >
    <% } %>
</div>

<button class="bg-green-600 text-white px-6 py-3 rounded hover:bg-green-700">
    Update Buku
</button>

</form>

<script>
    function initTomSelect(selector, placeholderText) {
        new TomSelect(selector, {
            plugins: ['remove_button'],
            create: true,
            sortField: { field: "text", direction: "asc" },
            placeholder: placeholderText
        });
    }

    initTomSelect("#author-select", "Cari atau tambah penulis...");
    initTomSelect("#publisher-select", "Cari atau tambah penerbit...");
    initTomSelect("#subject-select", "Cari atau tambah subjek...");
    initTomSelect("#category-select", "Cari atau tambah kategori...");

    const removeCoverBtn = document.getElementById('remove-cover');
    const existingCover = document.getElementById('existing-cover');
    const coverInput = document.getElementById('cover-input');

    if (removeCoverBtn) {
        removeCoverBtn.addEventListener('click', () => {
            existingCover.remove();          // hapus nama file
            coverInput.classList.remove('hidden'); // munculkan input file
            coverInput.value = "";           // reset input
        });
    }
</script>

<%- include('partials/footer') %>