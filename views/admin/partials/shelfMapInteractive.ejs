<div class="bg-white border border-gray-200 rounded-lg overflow-hidden shadow-sm">
    <div class="bg-gray-100 px-4 py-3 border-b flex justify-between items-center">
        <h3 class="font-bold text-gray-700 flex items-center">
            <i class="fas fa-map-marked-alt text-blue-600 mr-2"></i> Pilih Lokasi Rak
        </h3>
    </div>
    
    <div class="p-6">
        <% 
            // Ambil parameter isPopup di awal untuk menghindari error
            const isPopupParam = typeof isPopup !== 'undefined' ? isPopup : false;
            
            // Ambil shelfLocation dari parameter (untuk highlight awal jika ada)
            let shelfRaw = typeof shelfLocation !== 'undefined' ? shelfLocation : '';
            // Normalisasi: hapus prefix "Rak " jika ada, ubah ke uppercase
            let shelf = shelfRaw.replace(/^Rak\s*/i, '').trim().toUpperCase();
            
            // Fungsi untuk cek apakah rak ini adalah lokasi buku
            function isBookRack(rackId, rackId2) {
                if (!shelf) return false;
                const shelfUpper = shelf.toUpperCase();
                return shelfUpper === rackId.toUpperCase() || (rackId2 && shelfUpper === rackId2.toUpperCase());
            }

            // --- LAYOUT DATA ---
            const layoutData = [
                // --- 1. AREA ATAS KIRI ---
                { id: 'cab1', type: 'cabinet', label: '', x: 2, y: 3, w: 5, h: 4, color: 'bg-gray-300' },
                { id: 'cab2', type: 'cabinet', label: '', x: 2, y: 8, w: 5, h: 4, color: 'bg-gray-300' },
                
                // Meja hijau toska vertikal (di bawah kabinet)
                { id: 'desk_left_top', type: 'desk', label: '', x: 3, y: 16, w: 4, h: 12, color: 'bg-teal-400' },

                // Meja Pustakawan
                { id: 'lib_desk', type: 'desk', label: '', x: 13, y: 8, w: 22, h: 7, color: 'bg-teal-400' },

                // --- 2. SIDEBAR KIRI (MEJA PENGUNJUNG VERTIKAL) ---
                { id: 'visit_v_1', type: 'desk', label: '', x: 2, y: 35, w: 5, h: 12, color: 'bg-red-400', verticalText: true },
                { id: 'visit_v_2', type: 'desk', label: '', x: 2, y: 50, w: 5, h: 12, color: 'bg-red-400', verticalText: true },
                { id: 'visit_v_3', type: 'desk', label: '', x: 2, y: 65, w: 5, h: 12, color: 'bg-red-400', verticalText: true },

                // --- 3. POJOK KIRI BAWAH (MEJA PENGUNJUNG HORIZONTAL) ---
                { id: 'visit_h_1', type: 'desk', label: '', x: 2, y: 85, w: 9, h: 7, color: 'bg-red-400' },
                { id: 'visit_h_2', type: 'desk', label: '', x: 13, y: 85, w: 9, h: 7, color: 'bg-red-400' },
                { id: 'visit_h_3', type: 'desk', label: '', x: 24, y: 85, w: 9, h: 7, color: 'bg-red-400' },

                // --- 4. TENGAH RUANGAN ---
                { id: 'center_1', type: 'desk', label: '', x: 45, y: 40, w: 13, h: 12, color: 'bg-red-400' },
                { id: 'center_2', type: 'desk', label: '', x: 59, y: 40, w: 13, h: 12, color: 'bg-red-400' },
                { id: 'center_3', type: 'desk', label: '', x: 73, y: 40, w: 13, h: 12, color: 'bg-red-400' },
                
                // Meja Buku Tamu (Hijau)
                { id: 'guest_book', type: 'desk', label: '', x: 38, y: 65, w: 6, h: 6, color: 'bg-green-400' },

                // --- 5. POJOK KANAN BAWAH (KOTAK MERAH) ---
                { id: 'corner_red', type: 'desk', label: '', x: 85, y: 85, w: 8, h: 8, color: 'bg-red-400' }
            ];

            // --- LOGIKA RAK BUKU ---
            const rackStartX = 45; 
            const rackWidth = 4;
            const rackGap = 1.2;   
            
            // A. RAK ATAS (8 Kolom: A1-H1)
            const topLabels = ['A1', 'B1', 'C1', 'D1', 'E1', 'F1', 'G1', 'H1'];
            for (let i = 0; i < 8; i++) {
                const currentX = rackStartX + (i * (rackWidth + rackGap));
                const label = topLabels[i];
                
                layoutData.push({ 
                    id: `rack_top_${i}`, type: 'rack', label: label, 
                    x: currentX, y: 5, w: rackWidth, h: 24, color: 'bg-gray-300', 
                    verticalText: true, rackId: label
                });
            }

            // B. RAK BAWAH (8 Kolom: A2-H2)
            const bottomLabels = ['A2', 'B2', 'C2', 'D2', 'E2', 'F2', 'G2', 'H2'];
            
            // 4 Rak gabungan pertama (A2-D2)
            for (let i = 0; i < 4; i++) {
                const currentX = rackStartX + (i * (rackWidth + rackGap));
                const label = bottomLabels[i];
                layoutData.push({ 
                    id: `rack_bot_${i}`, type: 'rack', label: label, 
                    x: currentX, y: 65, w: rackWidth, h: 24, color: 'bg-gray-300', 
                    verticalText: true, rackId: label
                });
            }

            // Rak E2 (gap)
            const gapRackX = rackStartX + (4 * (rackWidth + rackGap));
            layoutData.push({ 
                id: 'rack_gap', type: 'rack', label: 'E2', 
                x: gapRackX, y: 77, w: rackWidth, h: 12, color: 'bg-gray-300', 
                verticalText: true, rackId: 'E2'
            });

            // 2 Rak gabungan setelah E2 (F2, G2)
            for (let i = 0; i < 2; i++) {
                const currentX = rackStartX + ((5 + i) * (rackWidth + rackGap));
                const label = bottomLabels[5 + i];
                layoutData.push({ 
                    id: `rack_bot_${5 + i}`, type: 'rack', label: label, 
                    x: currentX, y: 65, w: rackWidth, h: 24, color: 'bg-gray-300', 
                    verticalText: true, rackId: label
                });
            }

            // C. RAK VERTIKAL POJOK KANAN (H2)
            layoutData.push({ 
                id: 'rack_right_combined', type: 'rack', label: 'H2', 
                x: 88, y: 55, w: 4, h: 24, color: 'bg-gray-300', 
                verticalText: true, rackId: 'H2'
            });
        %>

        <%
            // Tentukan ukuran map berdasarkan apakah ini popup atau tidak
            // Gunakan isPopupParam yang sudah didefinisikan di awal
            const mapSizeClass = isPopupParam ? 'aspect-[2/1] max-h-[350px]' : 'aspect-[16/9]';
        %>
        <div 
            id="shelf-map-container" 
            class="relative w-full <%= mapSizeClass %> bg-white border border-gray-300 shadow-sm rounded-lg overflow-hidden"
            data-input-field-id="<%= typeof inputFieldId !== 'undefined' ? inputFieldId : 'shelf_location' %>"
        >
            
            <% layoutData.forEach(item => { 
                const isHighlighted = item.type === 'rack' && item.rackId && isBookRack(item.rackId, item.rackId2);
                
                // === LOGIKA HIGHLIGHT (BIRU) ===
                // Jika aktif: Gunakan warna Biru (blue-600), shadow biru, border biru tua
                const finalColor = isHighlighted ? 'bg-blue-600 animate-pulse shadow-[0_0_15px_rgba(37,99,235,0.6)] z-10' : item.color;
                const textColor = isHighlighted ? 'text-white' : (item.type === 'desk' ? 'text-white' : 'text-gray-700');
                const borderColor = isHighlighted ? 'border-blue-800 border-2' : 'border-gray-500/30 border';
                
                // Untuk rak, tambahkan class untuk interaktif
                const clickableClass = item.type === 'rack' && item.rackId ? 'cursor-pointer hover:scale-110 hover:shadow-lg' : 'cursor-default';
                const dataRackId = item.type === 'rack' && item.rackId ? `data-rack-id="${item.rackId}"` : '';
            %>
                <div 
                    class="absolute flex items-center justify-center rounded-sm transition-all <%= finalColor %> <%= textColor %> <%= borderColor %> <%= clickableClass %> p-0"
                    <%= dataRackId %>
                    style="
                        left: <%= item.x %>%;
                        top: <%= item.y %>%;
                        width: <%= item.w %>%;
                        height: <%= item.h %>%;
                    "
                >
                    <% if (item.type === 'rack' && item.label) { %>
                        <span 
                            class="text-[7px] md:text-[8px] font-bold text-center leading-none tracking-tighter overflow-hidden w-full"
                            style="
                                writing-mode: <%= item.verticalText ? 'vertical-rl' : 'horizontal-tb' %>;
                                transform: <%= item.verticalText ? 'rotate(180deg)' : 'none' %>;
                                display: flex;
                                align-items: center;
                                justify-content: center;
                                width: 100%;
                                height: 100%;
                                padding: 1px;
                            "
                        >
                            <%= item.label %>
                        </span>
                    <% } %>
                </div>
            <% }); %>
            
        </div>
        
        <div class="mt-6 flex flex-wrap justify-center gap-4 text-xs font-medium text-gray-600">
            <div class="flex items-center gap-2">
                <div class="w-4 h-4 bg-gray-300 border border-gray-400"></div> 
                <span>Rak Buku</span>
            </div>
            <div class="flex items-center gap-2">
                <div class="w-4 h-4 bg-teal-400 border border-gray-400"></div> 
                <span>Meja Pustakawan</span>
            </div>
            <div class="flex items-center gap-2">
                <div class="w-4 h-4 bg-red-400 border border-gray-400"></div> 
                <span>Meja Pengunjung</span>
            </div>
            <div class="flex items-center gap-2">
                <div class="w-4 h-4 bg-green-400 border border-gray-400"></div> 
                <span>Meja Buku Tamu</span>
            </div>
            <div id="selected-rack-indicator" class="flex items-center gap-2 p-1 bg-blue-50 rounded border border-blue-200 hidden">
                <div class="w-4 h-4 bg-blue-600 border border-blue-800 animate-pulse"></div> 
                <span class="text-blue-800 font-bold">Rak Terpilih: <span id="selected-rack-label">-</span></span>
            </div>
        </div>
        
    </div>
</div>

<script>
document.addEventListener('DOMContentLoaded', function() {
    // Ambil inputFieldId dari data attribute container
    const mapContainer = document.getElementById('shelf-map-container');
    if (!mapContainer) return;
    
    const inputFieldId = mapContainer.getAttribute('data-input-field-id') || 'shelf_location';
    const inputField = document.getElementById(inputFieldId);
    
    if (!inputField) {
        console.error('Input field dengan ID "' + inputFieldId + '" tidak ditemukan');
        return;
    }

    // State untuk rak yang dipilih
    let selectedRackId = null;
    
    // Fungsi untuk update highlight
    function updateHighlight(rackId) {
        if (!mapContainer) return;
        
        // Hapus highlight dari semua rak (hanya dalam mapContainer)
        const allRacks = mapContainer.querySelectorAll('[data-rack-id]');
        
        const rackIdClean = rackId ? rackId.trim().toUpperCase() : '';
        
        allRacks.forEach(rack => {
            let currentRackId = rack.getAttribute('data-rack-id');
            // Hapus tanda kutip ganda jika ada
            if (currentRackId) {
                currentRackId = currentRackId.replace(/^["']+|["']+$/g, '').trim().toUpperCase();
            }
            const isSelected = currentRackId === rackIdClean;
            
            if (isSelected) {
                // Highlight rak yang dipilih - gunakan inline style untuk memastikan ter-apply
                rack.classList.remove('bg-gray-300', 'text-gray-700', 'border-gray-500/30', 'border');
                rack.classList.add('bg-blue-600', 'text-white', 'border-blue-800', 'border-2', 'animate-pulse', 'z-10');
                
                // Set inline style dengan !important untuk memastikan warna ter-apply
                rack.style.setProperty('background-color', '#2563eb', 'important'); // blue-600
                rack.style.setProperty('color', '#ffffff', 'important');
                rack.style.setProperty('border-color', '#1e3a8a', 'important'); // blue-800
                rack.style.setProperty('border-width', '2px', 'important');
                rack.style.setProperty('border-style', 'solid', 'important');
                rack.style.setProperty('z-index', '10', 'important');
                rack.style.setProperty('box-shadow', '0 0 15px rgba(37,99,235,0.6)', 'important');
            } else {
                // Reset rak yang tidak dipilih
                rack.classList.remove('bg-blue-600', 'text-white', 'border-blue-800', 'border-2', 'animate-pulse', 'z-10');
                rack.classList.add('bg-gray-300', 'text-gray-700', 'border-gray-500/30', 'border');
                
                // Reset inline style
                rack.style.removeProperty('background-color');
                rack.style.removeProperty('color');
                rack.style.removeProperty('border-color');
                rack.style.removeProperty('border-width');
                rack.style.removeProperty('border-style');
                rack.style.removeProperty('z-index');
                rack.style.removeProperty('box-shadow');
            }
        });
        
        // Update indicator
        const indicator = document.getElementById('selected-rack-indicator');
        const label = document.getElementById('selected-rack-label');
        if (indicator && label) {
            if (rackId) {
                label.textContent = rackId;
                indicator.classList.remove('hidden');
            } else {
                indicator.classList.add('hidden');
            }
        }
    }
    
    // Event listener untuk klik rak
    if (mapContainer) {
        mapContainer.addEventListener('click', function(e) {
            // Cari elemen rak yang diklik (bisa rak itu sendiri atau child-nya)
            let rackElement = e.target.closest('[data-rack-id]');
            
            if (rackElement) {
                const rackId = rackElement.getAttribute('data-rack-id');
                if (rackId) {
                    selectedRackId = rackId;
                    
                    // Update input field dengan format "Rak [LABEL]"
                    const shelfValue = 'Rak ' + rackId;
                    inputField.value = shelfValue;
                    
                    // Update highlight
                    updateHighlight(rackId);
                    
                    // Trigger change event untuk notifikasi jika diperlukan
                    inputField.dispatchEvent(new Event('change', { bubbles: true }));
                }
            }
        });
    }
    
    // Fungsi untuk inisialisasi highlight berdasarkan nilai input
    function initializeHighlight() {
        if (!inputField || !mapContainer) return;
        
        // Pastikan map container sudah terlihat (popup sudah terbuka)
        const modal = document.getElementById('shelf-map-modal');
        if (modal && modal.classList.contains('hidden')) {
            return; // Skip jika popup masih hidden
        }
        
        // Cek apakah ada rak di map
        const allRacks = mapContainer.querySelectorAll('[data-rack-id]');
        if (allRacks.length === 0) {
            return; // Skip jika rak belum ter-render
        }
        
        if (inputField.value) {
            const currentValue = inputField.value.trim();
            // Ekstrak rak ID dari format "Rak A1" atau "A1"
            const match = currentValue.match(/Rak\s*([A-H][12])/i) || currentValue.match(/^([A-H][12])$/i);
            if (match && match[1]) {
                const rackId = match[1].toUpperCase().trim();
                
                // Cek apakah rak sudah ter-highlight dengan benar
                let alreadyHighlighted = false;
                allRacks.forEach(rack => {
                    let currentRackId = rack.getAttribute('data-rack-id');
                    if (currentRackId) {
                        currentRackId = currentRackId.replace(/^["']+|["']+$/g, '').trim().toUpperCase();
                    }
                    if (currentRackId === rackId) {
                        const computedBg = window.getComputedStyle(rack).backgroundColor;
                        // Cek apakah sudah ter-highlight (biru)
                        if (computedBg.includes('rgb(37, 99, 235)') || computedBg.includes('rgb(37,99,235)')) {
                            alreadyHighlighted = true;
                        }
                    }
                });
                
                // Jika sudah ter-highlight, skip untuk menghindari flicker
                if (alreadyHighlighted && selectedRackId === rackId) {
                    return;
                }
                
                selectedRackId = rackId;
                updateHighlight(rackId);
            }
        } else {
            // Jika tidak ada nilai, pastikan tidak ada yang ter-highlight
            allRacks.forEach(rack => {
                rack.classList.remove('bg-blue-600', 'text-white', 'border-blue-800', 'border-2', 'animate-pulse', 'z-10');
                rack.classList.add('bg-gray-300', 'text-gray-700', 'border-gray-500/30', 'border');
                
                // Reset inline style
                rack.style.removeProperty('background-color');
                rack.style.removeProperty('color');
                rack.style.removeProperty('border-color');
                rack.style.removeProperty('border-width');
                rack.style.removeProperty('border-style');
                rack.style.removeProperty('z-index');
                rack.style.removeProperty('box-shadow');
            });
        }
    }

    // Inisialisasi saat pertama kali load (skip jika map di dalam popup yang hidden)
    const modal = document.getElementById('shelf-map-modal');
    if (!modal || !modal.classList.contains('hidden')) {
        // Hanya inisialisasi jika popup tidak ada atau sudah terlihat
        initializeHighlight();
    }

    // Listen untuk event custom dari popup handler (untuk reset saat popup dibuka)
    if (mapContainer) {
        mapContainer.addEventListener('shelfLocationUpdated', function(e) {
            if (e.detail && e.detail.value) {
                // Update nilai input field
                inputField.value = e.detail.value;
                
                // Pastikan format benar
                let valueToUse = e.detail.value.trim();
                if (valueToUse && !valueToUse.match(/^Rak\s+/i)) {
                    const match = valueToUse.match(/^([A-H][12])$/i);
                    if (match) {
                        valueToUse = 'Rak ' + match[1];
                        inputField.value = valueToUse;
                    }
                }
                
                // Gunakan multiple delays untuk memastikan map sudah ter-render
                [50, 150, 300, 500].forEach(delay => {
                    setTimeout(function() {
                        initializeHighlight();
                    }, delay);
                });
            } else {
                // Jika tidak ada nilai, reset highlight
                const allRacks = mapContainer.querySelectorAll('[data-rack-id]');
                allRacks.forEach(rack => {
                    rack.classList.remove('bg-blue-600', 'text-white', 'border-blue-800', 'border-2', 'animate-pulse', 'z-10');
                    rack.classList.add('bg-gray-300', 'text-gray-700', 'border-gray-500/30', 'border');
                    rack.style.removeProperty('background-color');
                    rack.style.removeProperty('color');
                    rack.style.removeProperty('border-color');
                    rack.style.removeProperty('border-width');
                    rack.style.removeProperty('border-style');
                    rack.style.removeProperty('z-index');
                    rack.style.removeProperty('box-shadow');
                });
            }
        });
    }

    // Re-inisialisasi saat popup dibuka (observe modal visibility)
    if (modal) {
        const observer = new MutationObserver(function(mutations) {
            mutations.forEach(function(mutation) {
                if (mutation.type === 'attributes' && mutation.attributeName === 'class') {
                    const isVisible = !modal.classList.contains('hidden');
                    if (isVisible) {
                        // Popup baru dibuka, re-inisialisasi highlight dengan multiple delays
                        setTimeout(function() {
                            initializeHighlight();
                        }, 100);
                        setTimeout(function() {
                            initializeHighlight();
                        }, 300);
                        setTimeout(function() {
                            initializeHighlight();
                        }, 500);
                    }
                }
            });
        });
        observer.observe(modal, { attributes: true, attributeFilter: ['class'] });
    }

    // Juga listen untuk event custom 'popupOpened' dari parent
    window.addEventListener('shelfMapPopupOpened', function() {
        // Pastikan nilai input field sudah benar
        if (inputField && inputField.value) {
            let valueToUse = inputField.value.trim();
            if (valueToUse && !valueToUse.match(/^Rak\s+/i)) {
                const match = valueToUse.match(/^([A-H][12])$/i);
                if (match) {
                    valueToUse = 'Rak ' + match[1];
                    inputField.value = valueToUse;
                }
            }
        }
        
        // Gunakan multiple attempts untuk memastikan highlight berjalan
        [50, 150, 300, 500, 700, 1000].forEach(delay => {
            setTimeout(function() {
                initializeHighlight();
            }, delay);
        });
    });

    // Listen untuk event force initialize
    window.addEventListener('forceInitializeHighlight', function(e) {
        if (e.detail && e.detail.value && inputField) {
            inputField.value = e.detail.value;
        }
        setTimeout(function() {
            initializeHighlight();
        }, 100);
        setTimeout(function() {
            initializeHighlight();
        }, 300);
    });

    // Expose fungsi untuk bisa dipanggil langsung dari luar
    if (mapContainer) {
        mapContainer.highlightFromValue = function(value) {
            // Pastikan input field tersedia
            const field = document.getElementById(inputFieldId);
            if (field && value) {
                field.value = value;
            }
            
            // Pastikan map container tersedia
            const container = document.getElementById('shelf-map-container');
            if (!container) return;
            
            // Baca nilai dari input field
            const currentValue = field ? field.value.trim() : '';
            if (!currentValue) return;
            
            // Ekstrak rak ID
            const match = currentValue.match(/Rak\s*([A-H][12])/i) || currentValue.match(/^([A-H][12])$/i);
            if (!match || !match[1]) return;
            
            const rackId = match[1].toUpperCase();
            
            // Cari rak dan highlight
            const allRacks = container.querySelectorAll('[data-rack-id]');
            allRacks.forEach(rack => {
                const currentRackId = rack.getAttribute('data-rack-id');
                const isSelected = currentRackId && currentRackId.toUpperCase() === rackId;
                
                if (isSelected) {
                    rack.classList.remove('bg-gray-300', 'text-gray-700', 'border-gray-500/30', 'border');
                    rack.classList.add('bg-blue-600', 'text-white', 'border-blue-800', 'border-2', 'animate-pulse', 'z-10');
                    
                    // Set inline style dengan !important untuk memastikan warna ter-apply
                    rack.style.setProperty('background-color', '#2563eb', 'important'); // blue-600
                    rack.style.setProperty('color', '#ffffff', 'important');
                    rack.style.setProperty('border-color', '#1e3a8a', 'important'); // blue-800
                    rack.style.setProperty('border-width', '2px', 'important');
                    rack.style.setProperty('border-style', 'solid', 'important');
                    rack.style.setProperty('z-index', '10', 'important');
                    rack.style.setProperty('box-shadow', '0 0 15px rgba(37,99,235,0.6)', 'important');
                } else {
                    rack.classList.remove('bg-blue-600', 'text-white', 'border-blue-800', 'border-2', 'animate-pulse', 'z-10');
                    rack.classList.add('bg-gray-300', 'text-gray-700', 'border-gray-500/30', 'border');
                    
                    // Reset inline style
                    rack.style.removeProperty('background-color');
                    rack.style.removeProperty('color');
                    rack.style.removeProperty('border-color');
                    rack.style.removeProperty('border-width');
                    rack.style.removeProperty('border-style');
                    rack.style.removeProperty('z-index');
                    rack.style.removeProperty('box-shadow');
                }
            });
            
            // Update indicator
            const indicator = document.getElementById('selected-rack-indicator');
            const label = document.getElementById('selected-rack-label');
            if (indicator && label) {
                label.textContent = rackId;
                indicator.classList.remove('hidden');
            }
        };
    }
});
</script>
