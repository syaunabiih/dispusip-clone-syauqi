<%- include('../partials/header') %>

<script src="https://cdn.jsdelivr.net/npm/sweetalert2@11"></script>

<div class="flex flex-col gap-6">
    <div class="flex flex-col md:flex-row justify-between items-start md:items-center gap-4">
        <div>
            <h2 class="text-2xl font-bold text-gray-800 flex items-center gap-2">
                <i class="fas fa-truck-moving text-blue-600"></i> <%= title %>
            </h2>
            <p class="text-sm text-gray-500 mt-1">Kelola stok dan sirkulasi buku pada unit layanan keliling.</p>
        </div>
        
        <div class="flex flex-wrap gap-2">
            <a href="/admin/puskel/template" class="bg-white border border-gray-300 text-gray-700 px-3 py-2 rounded-lg text-sm font-semibold hover:bg-gray-50 shadow-sm flex items-center gap-2">
                <i class="fas fa-download text-gray-500"></i> Format
            </a>
            <button onclick="openModal('modalImport')" class="bg-green-50 text-green-700 border border-green-200 px-3 py-2 rounded-lg text-sm font-semibold hover:bg-green-100 shadow-sm flex items-center gap-2">
                <i class="fas fa-file-excel"></i> Import
            </button>
            <a href="/admin/puskel/export" target="_blank" class="bg-blue-50 text-blue-700 border border-blue-200 px-3 py-2 rounded-lg text-sm font-semibold hover:bg-blue-100 shadow-sm flex items-center gap-2">
                <i class="fas fa-file-export"></i> Export
            </a>
            <button onclick="openModal('modalAddStock')" class="bg-blue-600 hover:bg-blue-700 text-white px-4 py-2 rounded-lg text-sm font-semibold shadow-md flex items-center gap-2">
                <i class="fas fa-plus-circle"></i> Input Buku
            </button>
        </div>
    </div>

    <div class="bg-gray-50 p-4 rounded-xl border border-gray-200 flex flex-col md:flex-row gap-4 justify-between items-center">
        
        <div class="relative w-full md:w-96">
            <div class="absolute inset-y-0 left-0 pl-3 flex items-center pointer-events-none">
                <i class="fas fa-search text-gray-400"></i>
            </div>
            <input type="text" id="searchInput" onkeyup="filterTable()" 
                class="pl-10 p-2.5 w-full border border-gray-300 rounded-lg text-sm focus:ring-blue-500 focus:border-blue-500 bg-white shadow-sm" 
                placeholder="Cari Judul, Penulis, No Induk...">
        </div>

        <div class="flex items-center gap-3 w-full md:w-auto">
            <label class="text-xs font-bold text-gray-500 uppercase"><i class="fas fa-sort mr-1"></i>Urutkan:</label>
            <select id="sortSelect" onchange="sortTable()" class="p-2 border border-gray-300 rounded-lg text-sm focus:ring-blue-500 focus:border-blue-500 bg-white shadow-sm cursor-pointer min-w-[180px]">
                <option value="newest">Terbaru (Default)</option>
                <option value="title_asc">Judul (A-Z)</option>
                <option value="title_desc">Judul (Z-A)</option>
                <option value="call_asc">No. Panggil (0-9)</option>
                <option value="call_desc">No. Panggil (9-0)</option>
            </select>
        </div>
    </div>

    <div class="bg-white rounded-xl shadow-md border border-gray-100 overflow-hidden">
        <div class="overflow-x-auto">
            <table class="w-full text-sm text-left text-gray-500" id="booksTable">
                <thead class="text-xs text-gray-700 uppercase bg-gray-50">
                    <tr>
                        <th class="px-6 py-3 text-center w-10">No</th>
                        <th class="px-6 py-3">Judul Buku</th>
                        <th class="px-6 py-3">No. Induk</th>
                        <th class="px-6 py-3 text-center">No. Panggil</th>
                        <th class="px-6 py-3 text-center">Jumlah</th>
                        <th class="px-6 py-3 text-center">Status / Lokasi</th>
                        <th class="px-6 py-3 text-center">Aksi</th>
                    </tr>
                </thead>
                <tbody id="booksTableBody">
                    <% if (copies.length > 0) { %>
                        <% copies.forEach((copy, index) => { %>
                        <tr class="bg-white border-b hover:bg-gray-50 transition-colors book-row"
                            data-index="<%= index %>"
                            data-title="<%= copy.Book ? copy.Book.title.toLowerCase() : '' %>"
                            data-author="<%= (copy.Book && copy.Book.Authors) ? copy.Book.Authors.map(a => a.name.toLowerCase()).join(' ') : '' %>"
                            data-noinduk="<%= copy.no_induk.toLowerCase() %>"
                            data-callnumber="<%= copy.Book ? copy.Book.call_number : '' %>">
                            
                            <td class="px-6 py-4 text-center font-medium text-gray-500 row-number"><%= index + 1 %></td>
                            <td class="px-6 py-4">
                                <div class="font-bold text-gray-800 text-base"><%= copy.Book ? copy.Book.title : 'Judul Error' %></div>
                                <div class="text-xs text-gray-500 mt-0.5 font-medium">
                                    <%= (copy.Book && copy.Book.Authors && copy.Book.Authors.length > 0) ? copy.Book.Authors.map(a => a.name).join(', ') : 'Tanpa Pengarang' %>
                                    â€¢ <%= copy.Book ? copy.Book.publish_year : '-' %>
                                </div>
                            </td>
                            <td class="px-6 py-4 font-mono text-xs">
                                <span class="bg-gray-100 px-2 py-1 rounded border border-gray-200 text-gray-600 font-bold">
                                    <%= copy.no_induk %>
                                </span>
                            </td>
                            <td class="px-6 py-4 text-center font-bold text-blue-600">
                                <%= copy.Book ? copy.Book.call_number : '-' %>
                            </td>
                            <td class="px-6 py-4 text-center">1 Eks</td>
                            <td class="px-6 py-4 text-center">
                                <% if (copy.status === 'tersedia_puskel') { %>
                                    <span class="bg-green-100 text-green-700 text-xs font-bold px-2.5 py-1 rounded-full border border-green-200 inline-flex items-center gap-1">
                                        <i class="fas fa-check-circle"></i> Ready
                                    </span>
                                <% } else { %>
                                    <div class="flex flex-col items-center gap-1">
                                        <span class="bg-yellow-100 text-yellow-700 text-xs font-bold px-2.5 py-1 rounded-full border border-yellow-200 inline-flex items-center gap-1">
                                            <i class="fas fa-clock"></i> Dipinjam
                                        </span>
                                        <% if(copy.puskelLoans && copy.puskelLoans.length > 0 && copy.puskelLoans[0].institution) { %>
                                            <span class="text-[10px] text-blue-600 font-semibold bg-blue-50 px-2 py-0.5 rounded border border-blue-100">
                                                <%= copy.puskelLoans[0].institution.name %>
                                            </span>
                                        <% } %>
                                    </div>
                                <% } %>
                            </td>
                            <td class="px-6 py-4 text-center">
                                <% if (copy.status === 'tersedia_puskel') { %>
                                    <button onclick="confirmReturnStock('<%= copy.id %>', '<%= copy.Book ? copy.Book.title : 'Buku' %>')" 
                                        class="text-red-500 hover:text-red-700 text-xs font-semibold border border-red-200 bg-red-50 px-2 py-1 rounded transition-colors flex items-center gap-1 mx-auto hover:bg-red-100">
                                        <i class="fas fa-undo"></i> Hapus
                                    </button>
                                <% } else { %>
                                    <span class="text-gray-400 text-xs flex items-center justify-center gap-1"><i class="fas fa-lock"></i> Terkunci</span>
                                <% } %>
                            </td>
                        </tr>
                        <% }) %>
                    <% } else { %>
                        <tr id="noDataRow"><td colspan="7" class="text-center py-12 text-gray-400">Belum ada stok buku di Puskel.</td></tr>
                    <% } %>
                    <tr id="searchNoResult" class="hidden">
                        <td colspan="7" class="text-center py-12 text-gray-400">
                            <div class="flex flex-col items-center">
                                <i class="fas fa-search text-4xl mb-2 text-gray-200"></i>
                                <span>Data tidak ditemukan untuk kata kunci tersebut.</span>
                            </div>
                        </td>
                    </tr>
                </tbody>
            </table>
        </div>
    </div>
</div>

<div id="modalAddStock" class="fixed inset-0 z-50 hidden flex items-center justify-center p-4">
    <div class="absolute inset-0 bg-gray-900 opacity-50 backdrop-blur-sm transition-opacity" onclick="closeModal('modalAddStock')"></div>
    <div class="bg-white rounded-xl shadow-2xl w-full max-w-lg z-10 p-6 relative max-h-[90vh] overflow-y-auto transform transition-all scale-100 animate-fade-in-down">
        
        <div class="flex justify-between items-center mb-4">
            <h3 class="text-lg font-bold text-gray-800">
                <i class="fas fa-plus-circle text-blue-600 mr-2"></i> Input Buku ke Puskel
            </h3>
            <button onclick="closeModal('modalAddStock')" class="text-gray-400 hover:text-gray-600"><i class="fas fa-times"></i></button>
        </div>

        <form id="formAddStock" action="/admin/puskel/add-stock" method="POST" class="space-y-4">
            
            <div class="mb-4 bg-blue-50 p-3 rounded-lg border border-blue-200">
                <label class="block text-xs font-bold text-blue-800 mb-1 uppercase">Scan ISBN (Auto Fill):</label>
                <div class="relative">
                    <input type="text" id="isbnScanner" class="w-full pl-8 p-2 border border-blue-300 rounded text-sm focus:ring-blue-500 focus:border-blue-500" placeholder="Scan barcode buku disini..." autofocus>
                    <div class="absolute inset-y-0 left-0 flex items-center pl-2 pointer-events-none">
                        <i class="fas fa-barcode text-blue-500"></i>
                    </div>
                    <span id="loadingScan" class="absolute inset-y-0 right-0 flex items-center pr-2 text-xs text-blue-600 hidden font-bold animate-pulse">Searching...</span>
                </div>
            </div>

            <div>
                <label class="block text-sm font-medium text-gray-700 mb-1">Judul Buku <span class="text-red-500">*</span></label>
                <input type="text" name="title" id="inputTitle" required class="w-full border border-gray-300 rounded-lg p-2.5 text-sm bg-gray-50 focus:bg-white transition-colors" placeholder="Masukkan judul buku...">
            </div>

            <div>
                <label class="block text-sm font-medium text-gray-700 mb-1">Pengarang</label>
                <input type="text" name="author" id="inputAuthor" class="w-full border border-gray-300 rounded-lg p-2.5 text-sm bg-gray-50 focus:bg-white transition-colors" placeholder="Nama penulis...">
            </div>

            <div class="grid grid-cols-2 gap-4">
                <div>
                    <label class="block text-sm font-medium text-gray-700 mb-1">No. Induk <span class="text-red-500">*</span></label>
                    <input type="text" name="no_induk" required class="w-full border border-gray-300 rounded-lg p-2.5 text-sm font-mono" placeholder="Cth: B-001">
                    <p class="text-[10px] text-gray-400 mt-1">Jika jumlah > 1, nomor ini jadi awalan.</p>
                </div>

                <div>
                    <label class="block text-sm font-medium text-gray-700 mb-1">No. Panggil</label>
                    <input type="text" name="call_number" class="w-full border border-gray-300 rounded-lg p-2.5 text-sm" placeholder="Cth: 813 TER b">
                </div>
            </div>

            <div>
                <label class="block text-sm font-medium text-gray-700 mb-1">Jumlah (Eks)</label>
                <input type="number" name="quantity" value="1" min="1" required class="w-full border border-gray-300 rounded-lg p-2.5 text-sm">
                <p class="text-[10px] text-gray-500 mt-1"><i class="fas fa-info-circle"></i> Jika buku sudah ada, statusnya akan dipindah ke Puskel.</p>
            </div>

            <div class="flex justify-end gap-2 pt-4 border-t mt-2">
                <button type="button" onclick="closeModal('modalAddStock')" class="px-4 py-2 text-gray-700 bg-gray-100 rounded-lg hover:bg-gray-200 text-sm font-medium">Batal</button>
                <button type="submit" class="px-4 py-2 bg-blue-600 text-white rounded-lg hover:bg-blue-700 text-sm font-medium shadow-sm flex items-center gap-2">
                    <i class="fas fa-save"></i> Simpan
                </button>
            </div>
        </form>
    </div>
</div>

<div id="modalImport" class="fixed inset-0 z-50 hidden flex items-center justify-center p-4">
    <div class="absolute inset-0 bg-gray-900 opacity-50 backdrop-blur-sm transition-opacity" onclick="closeModal('modalImport')"></div>
    <div class="bg-white rounded-xl shadow-2xl w-full max-w-md z-10 p-6 relative animate-fade-in-down">
        <div class="flex justify-between items-center mb-4">
            <h3 class="text-lg font-bold text-gray-800"><i class="fas fa-file-excel text-green-600 mr-2"></i> Import Data Excel</h3>
            <button onclick="closeModal('modalImport')" class="text-gray-400 hover:text-gray-600"><i class="fas fa-times"></i></button>
        </div>
        
        <form id="formImportExcel" action="/admin/puskel/import" method="POST" enctype="multipart/form-data" class="space-y-4">
            <div class="border-2 border-dashed border-green-300 rounded-lg p-6 text-center bg-green-50 hover:bg-green-100 transition-colors cursor-pointer relative group">
                <input type="file" id="fileInputExcel" name="excelFile" accept=".xlsx, .xls" required 
                    class="absolute inset-0 w-full h-full opacity-0 cursor-pointer z-10"
                    onchange="updateFileName(this)">
                
                <div id="dropZoneDefault" class="transition-opacity duration-300">
                    <i class="fas fa-cloud-upload-alt text-4xl text-green-500 mb-2 group-hover:scale-110 transition-transform"></i>
                    <p class="text-sm text-green-700 font-medium">Klik atau Tarik File Excel ke Sini</p>
                    <p class="text-xs text-gray-500 mt-1">Format: .xlsx, .xls (Maks 5MB)</p>
                </div>

                <div id="dropZoneFile" class="hidden flex-col items-center justify-center">
                    <i class="fas fa-file-excel text-4xl text-green-600 mb-2"></i>
                    <p class="text-sm text-gray-800 font-bold break-all" id="fileNameDisplay">Nama File.xlsx</p>
                    <p class="text-xs text-green-600 mt-1">Klik lagi untuk ganti file</p>
                </div>
            </div>
            
            <div class="flex justify-end gap-2 pt-4 border-t">
                <button type="button" onclick="closeModal('modalImport')" class="px-4 py-2 text-gray-700 bg-gray-100 rounded-lg hover:bg-gray-200 text-sm font-medium">Batal</button>
                <button type="submit" class="px-4 py-2 bg-green-600 text-white rounded-lg hover:bg-green-700 text-sm font-medium shadow-sm flex items-center gap-2">
                    <i class="fas fa-upload"></i> Upload
                </button>
            </div>
        </form>
    </div>
</div>

<script>
    // --- FITUR SEARCHING & SORTING TABLE ---
    const tableBody = document.getElementById('booksTableBody');
    const noResultRow = document.getElementById('searchNoResult');

    function filterTable() {
        const input = document.getElementById('searchInput');
        const filter = input.value.toLowerCase();
        const rows = document.querySelectorAll('.book-row');
        let hasVisibleRow = false;

        rows.forEach(row => {
            const title = row.getAttribute('data-title');
            const author = row.getAttribute('data-author');
            const noInduk = row.getAttribute('data-noinduk');
            const callNumber = row.getAttribute('data-callnumber').toLowerCase();

            // Cek apakah ada yang cocok
            if (title.includes(filter) || author.includes(filter) || noInduk.includes(filter) || callNumber.includes(filter)) {
                row.style.display = "";
                hasVisibleRow = true;
            } else {
                row.style.display = "none";
            }
        });

        // Tampilkan pesan "Tidak ditemukan" jika kosong
        if (!hasVisibleRow) {
            noResultRow.classList.remove('hidden');
        } else {
            noResultRow.classList.add('hidden');
        }
    }

    function sortTable() {
        const sortBy = document.getElementById('sortSelect').value;
        const rows = Array.from(document.querySelectorAll('.book-row'));
        
        rows.sort((a, b) => {
            if (sortBy === 'newest') {
                return parseInt(a.getAttribute('data-index')) - parseInt(b.getAttribute('data-index'));
            } else if (sortBy === 'title_asc') {
                return a.getAttribute('data-title').localeCompare(b.getAttribute('data-title'));
            } else if (sortBy === 'title_desc') {
                return b.getAttribute('data-title').localeCompare(a.getAttribute('data-title'));
            } else if (sortBy === 'call_asc') {
                return a.getAttribute('data-callnumber').localeCompare(b.getAttribute('data-callnumber'));
            } else if (sortBy === 'call_desc') {
                return b.getAttribute('data-callnumber').localeCompare(a.getAttribute('data-callnumber'));
            }
        });

        // Hapus semua baris dan masukkan ulang sesuai urutan baru
        rows.forEach(row => tableBody.appendChild(row));
        
        // Pindahkan baris 'searchNoResult' ke paling bawah lagi
        tableBody.appendChild(noResultRow);

        // Reset nomor urut tampilan (Opsional, kalau mau nomor tetap 1,2,3... meski disortir)
        updateRowNumbers();
    }

    function updateRowNumbers() {
        const visibleRows = document.querySelectorAll('.book-row:not([style*="display: none"])');
        visibleRows.forEach((row, index) => {
            row.querySelector('.row-number').innerText = index + 1;
        });
    }

    // Panggil filter setiap kali input berubah (sudah ada onkeyup di HTML)
    // Tapi kita perlu update nomor jika filter aktif
    document.getElementById('searchInput').addEventListener('keyup', updateRowNumbers);
    document.getElementById('sortSelect').addEventListener('change', updateRowNumbers);


    // --- LOGIKA LAIN (SCANNER, MODAL, DLL) ---
    const isbnInput = document.getElementById('isbnScanner');
    const titleInput = document.getElementById('inputTitle');
    const authorInput = document.getElementById('inputAuthor');
    const loadingText = document.getElementById('loadingScan');

    isbnInput.addEventListener('keypress', function (e) {
        if (e.key === 'Enter') {
            e.preventDefault(); 
            const isbn = this.value.trim();
            if (isbn) fetchBookData(isbn);
        }
    });

    let typingTimer;
    isbnInput.addEventListener('input', function () {
        clearTimeout(typingTimer);
        const isbn = this.value.trim();
        if (isbn.length === 10 || isbn.length === 13) {
            typingTimer = setTimeout(() => fetchBookData(isbn), 800);
        }
    });

    async function fetchBookData(isbn) {
        loadingText.classList.remove('hidden');
        titleInput.placeholder = "Mencari data...";
        authorInput.placeholder = "Mencari data...";

        try {
            const response = await fetch(`https://www.googleapis.com/books/v1/volumes?q=isbn:${isbn}`);
            const data = await response.json();

            if (data.totalItems > 0) {
                const bookInfo = data.items[0].volumeInfo;
                titleInput.value = bookInfo.title || "";
                authorInput.value = bookInfo.authors ? bookInfo.authors.join(', ') : "";
                
                titleInput.classList.add('bg-green-50', 'border-green-500');
                setTimeout(() => titleInput.classList.remove('bg-green-50', 'border-green-500'), 1000);
            }
        } catch (error) {
            console.error("Error fetching book:", error);
        } finally {
            loadingText.classList.add('hidden');
            titleInput.placeholder = "Masukkan judul buku...";
            authorInput.placeholder = "Nama penulis...";
        }
    }

    // --- MODAL CONTROL ---
    function openModal(id) { 
        document.getElementById(id).classList.remove('hidden'); 
        if(id === 'modalAddStock') setTimeout(() => document.getElementById('isbnScanner').focus(), 100);
    }
    function closeModal(id) { document.getElementById(id).classList.add('hidden'); }

    // --- TAMPILAN FILE UPLOAD ---
    function updateFileName(input) {
        const defaultZone = document.getElementById('dropZoneDefault');
        const fileZone = document.getElementById('dropZoneFile');
        const nameDisplay = document.getElementById('fileNameDisplay');

        if (input.files && input.files.length > 0) {
            const file = input.files[0];
            nameDisplay.textContent = file.name;
            defaultZone.classList.add('hidden');
            fileZone.classList.remove('hidden');
            fileZone.classList.add('flex');
        } else {
            defaultZone.classList.remove('hidden');
            fileZone.classList.add('hidden');
            fileZone.classList.remove('flex');
        }
    }

    // --- AJAX SUBMITS ---
    document.getElementById('formAddStock').addEventListener('submit', function(e) {
        e.preventDefault();
        const form = this;
        const formData = new FormData(form);
        const data = Object.fromEntries(formData.entries());

        Swal.fire({ title: 'Menyimpan...', didOpen: () => Swal.showLoading() });

        fetch(form.action, {
            method: 'POST',
            headers: { 'Content-Type': 'application/json' },
            body: JSON.stringify(data)
        })
        .then(res => {
            if(res.ok) {
                Swal.fire({
                    icon: 'success', title: 'Berhasil!', text: 'Buku berhasil ditambahkan ke Puskel',
                    timer: 1500, showConfirmButton: false
                }).then(() => window.location.reload());
            } else { throw new Error('Gagal menyimpan'); }
        })
        .catch(err => Swal.fire({ icon: 'error', title: 'Gagal', text: 'Terjadi kesalahan sistem' }));
    });

    document.getElementById('formImportExcel').addEventListener('submit', function(e) {
        e.preventDefault();
        const form = this;
        const formData = new FormData(form);

        Swal.fire({ title: 'Mengupload...', text: 'Mohon tunggu proses import', didOpen: () => Swal.showLoading() });

        fetch(form.action, { method: 'POST', body: formData })
        .then(res => {
            if(res.ok) {
                Swal.fire({
                    icon: 'success', title: 'Selesai!', text: 'Data buku berhasil diimport',
                    timer: 1500, showConfirmButton: false
                }).then(() => window.location.reload());
            } else { throw new Error('Gagal import'); }
        })
        .catch(err => Swal.fire({ icon: 'error', title: 'Gagal', text: 'Pastikan format Excel benar' }));
    });

    function confirmReturnStock(id, title) {
        Swal.fire({
            title: 'Hapus Dari Puskel?',
            text: `Kembalikan buku "${title}" ke Gudang Utama?`,
            icon: 'warning',
            showCancelButton: true,
            confirmButtonColor: '#d33',
            cancelButtonColor: '#3085d6',
            confirmButtonText: 'Ya, Kembalikan!',
            cancelButtonText: 'Batal'
        }).then((result) => {
            if (result.isConfirmed) {
                Swal.fire({ title: 'Memproses...', didOpen: () => Swal.showLoading() });
                
                fetch(`/admin/puskel/remove-stock/${id}`)
                .then(res => {
                    if(res.ok || res.redirected) { 
                        Swal.fire({
                            icon: 'success', title: 'Berhasil!', text: 'Buku dikembalikan ke Gudang Utama',
                            timer: 1500, showConfirmButton: false
                        }).then(() => window.location.reload());
                    } else { throw new Error('Gagal'); }
                })
                .catch(() => { window.location.href = `/admin/puskel/remove-stock/${id}`; });
            }
        });
    }
</script>

<style>
    @keyframes fadeInDown { from { opacity: 0; transform: translateY(-20px); } to { opacity: 1; transform: translateY(0); } }
    .animate-fade-in-down { animation: fadeInDown 0.3s ease-out; }
</style>

<%- include('../partials/footer') %>