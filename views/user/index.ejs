<%- include('partials/header') %>

<!-- Tom Select CSS -->
<link href="https://cdn.jsdelivr.net/npm/tom-select/dist/css/tom-select.bootstrap5.min.css" rel="stylesheet">
<link rel="stylesheet" href="/css/style.css">

<div class="w-[90%] mx-auto py-6">

    <main class="w-full">

        <div class="space-y-4 mb-8">
            <form action="/search" method="GET">
                
                <div class="bg-white p-6 rounded-xl border border-gray-200 shadow-sm mb-4">
                    <h2 class="text-lg font-bold text-gray-800 mb-4 flex items-center">
                        <i class="fas fa-search text-blue-600 mr-2"></i> Pencarian Koleksi
                    </h2>
                    <div class="flex flex-col md:flex-row gap-2">
                        <div class="flex-grow min-w-0">
                            <input type="text" name="q" value="<%= query.q || '' %>"
                                class="w-full p-2.5 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500 focus:border-blue-500 transition"
                                placeholder="Masukkan kata kunci pencarian...">
                        </div>

                        <div class="md:w-1/5 min-w-0">
                            <select name="searchBy" class="w-full p-2.5 bg-gray-50 border border-gray-300 rounded-lg">
                                <option value="title" <%= query.searchBy === 'title' ? 'selected' : '' %>>Judul</option>
                                <option value="author" <%= query.searchBy === 'author' ? 'selected' : '' %>>Pengarang</option>
                                <option value="publisher" <%= query.searchBy === 'publisher' ? 'selected' : '' %>>Penerbit</option>
                                <option value="subject" <%= query.searchBy === 'subject' ? 'selected' : '' %>>Subjek</option>
                            </select>
                        </div>

                        <div class="md:w-1/5 min-w-0">
                            <select name="matchType" class="w-full p-2.5 bg-gray-50 border border-gray-300 rounded-lg">
                                <option value="contains" <%= query.matchType === 'contains' ? 'selected' : '' %>>Salah Satu Isi</option>
                                <option value="startsWith" <%= query.matchType === 'startsWith' ? 'selected' : '' %>>Dimulai Dengan</option>
                                <option value="endsWith" <%= query.matchType === 'endsWith' ? 'selected' : '' %>>Diakhiri Dengan</option>
                                <option value="exact" <%= query.matchType === 'exact' ? 'selected' : '' %>>Tepat (Exact)</option>
                            </select>
                        </div>

                        <div class="min-w-0">
                            <button type="submit" class="bg-blue-600 hover:bg-blue-700 text-white px-8 py-2.5 rounded-lg font-bold w-full md:w-auto transition shadow-sm">
                                Cari
                            </button>
                        </div>
                    </div>
                </div>

                <div class="bg-white p-5 rounded-xl border border-blue-100 shadow-sm">
                    <div class="flex items-center mb-3">
                        <i class="fas fa-sliders-h text-blue-600 mr-2 text-sm"></i>
                        <span class="text-sm font-bold text-gray-700 uppercase tracking-wider">Filter Koleksi</span>
                    </div>
                    
                    <div class="grid grid-cols-1 md:grid-cols-4 gap-3">
                        <div class="min-w-0">
                            <select name="category" id="categorySelect" class="w-full p-2.5 bg-gray-50 border border-gray-300 rounded-lg">
                                <option value="">Semua Kategori</option>
                                <% sidebarData.categories.forEach(item => { %>
                                    <option value="<%= item.id %>" <%= query.category == item.id ? 'selected' : '' %>><%= item.name %></option>
                                <% }) %>
                            </select>
                        </div>

                        <div class="min-w-0">
                            <select name="subject" id="subjectSelect" class="w-full p-2.5 bg-gray-50 border border-gray-300 rounded-lg">
                                <option value="">Semua Subjek</option>
                                <% sidebarData.subjects.forEach(item => { %>
                                    <option value="<%= item.id %>" <%= query.subject == item.id ? 'selected' : '' %>><%= item.name %></option>
                                <% }) %>
                            </select>
                        </div>

                        <div class="min-w-0">
                            <select name="year" id="yearSelect" class="w-full p-2.5 bg-gray-50 border border-gray-300 rounded-lg">
                                <option value="">Semua Tahun</option>
                                <% sidebarData.years.forEach(item => { %>
                                    <option value="<%= item.year %>" <%= query.year == item.year ? 'selected' : '' %>><%= item.year %></option>
                                <% }) %>
                            </select>
                        </div>

                        <div class="min-w-0">
                            <button type="submit" class="w-full bg-blue-600 hover:bg-blue-700 text-white px-8 py-2.5 rounded-lg font-bold transition flex items-center justify-center gap-2">
                                <i class="fas fa-filter text-xs"></i> Terapkan Filter
                            </button>
                        </div>
                        <div class="mt-3 flex justify-between items-center">
                        <div class="flex gap-4 text-xs text-gray-500">
                            <a href="/" class="hover:text-blue-600 transition"><i class="fas fa-undo mr-1"></i> Reset Pencarian dan Filter</a>
                        </div>
                        <% if (query.q || query.category || query.subject || query.year) { %>
                            <span class="text-[10px] bg-blue-200 text-blue-800 px-2 py-0.5 rounded-full font-bold uppercase">Filter Aktif</span>
                        <% } %>
                    </div>
                    </div>
                </div>
            </form>
        </div>

            <!-- LIST BUKU -->
            <div class="space-y-4">
                <% if (books.length > 0) { %>
                    <% books.forEach(book => { %>
                        <a 
                            href="/book/<%= book.id %>?origin_q=<%= query.q %>&origin_searchBy=<%= query.searchBy %>&origin_matchType=<%= query.matchType %>&origin_category=<%= query.category %>&origin_subject=<%= query.subject %>&origin_year=<%= query.year %>&origin_page=<%= currentPage %>"
                            class="block bg-white p-4 rounded-lg border border-gray-200 hover:border-blue-400 hover:shadow-md transition flex flex-col sm:flex-row gap-4 group cursor-pointer"
                            >
                            <!-- Cover -->
                            <div class="w-24 h-32 bg-gray-100 rounded border overflow-hidden flex justify-center items-center">
                                <% if (book.image) { %>
                                    <img src="<%= book.image_full_path %>" class="w-full h-full object-contain">
                                <% } else { %>
                                    <div class="flex flex-col justify-center items-center">
                                        <i class="fas fa-book text-3xl mb-1"></i>
                                        <span class="text-[9px] text-center">SAMPUL BELUM TERSEDIA</span>
                                    </div>
                                <% } %>
                            </div>

                            <!-- Info -->
                            <div class="flex-grow text-sm">
                                <h4 class="text-base font-bold text-blue-700 group-hover:underline cursor-pointer"
                                    onclick="window.location.href='/book/<%= book.id %>?origin_q=<%= query.q %>&origin_searchBy=<%= query.searchBy %>&origin_matchType=<%= query.matchType %>&origin_category=<%= query.category %>&origin_subject=<%= query.subject %>&origin_year=<%= query.year %>&origin_page=<%= currentPage %>'">
                                    <%= book.title %>
                            </h4>
                                <div class="grid grid-cols-1 gap-y-1 text-gray-600">
                                    <div class="grid grid-cols-[100px_1fr]">
                                        <span class="font-semibold">Kategori</span>
                                        <span>: <%= book.Category ? book.Category.name : '-' %></span>
                                    </div>
                                    <div class="grid grid-cols-[100px_1fr]">
                                        <span class="font-semibold">Pengarang</span>
                                        <span>: <%= book.Authors.map(a => a.name).join(", ") %></span>
                                    </div>
                                    <div class="grid grid-cols-[100px_1fr]">
                                        <span class="font-semibold">Penerbitan</span>
                                        <span>: <%= book.publish_place %> : <%= book.Publishers.map(p => p.name).join(", ") %>, <%= book.publish_year %></span>
                                    </div>
                                </div>
                            </div>

                            <!-- Stock -->
                            <div class="sm:text-right sm:w-40 border-t sm:border-l sm:border-t-0 border-gray-100 sm:pl-4 pt-3 sm:pt-0">
                                <span class="text-xs font-semibold text-gray-500">Ketersediaan</span>
                                <div class="text-xs text-blue-600 font-medium">
                                    <%= book.stock_available %> dari <%= book.stock_total %> eks.
                                </div>

                                <div class="mt-2">
                                    <span class="px-2 py-1 bg-gray-100 text-gray-700 text-xs rounded border">
                                        <%= book.call_number %>
                                    </span>
                                </div>
                            </div>
                        </a>
                    <% }) %>
                <% } else { %>
                    <div class="p-10 text-center bg-gray-50 border border-dashed border-gray-300 rounded">
                        <p class="text-gray-500 font-medium">Data tidak ditemukan.</p>
                    </div>
                <% } %>
            </div>

            <!-- PAGINATION -->
            <% if (totalPages > 1) { %>
                <div class="mt-8 flex flex-wrap justify-center items-center gap-1">
                    
                    <% if (currentPage > 1) { %>
                        <a
                            href="/search?q=<%= query.q %>&searchBy=<%= query.searchBy %>&matchType=<%= query.matchType %>&category=<%= query.category %>&subject=<%= query.subject %>&year=<%= query.year %>&page=<%= parseInt(currentPage) - 1 %>"
                            class="px-3 py-1 border rounded text-sm bg-white text-gray-600 hover:bg-blue-50"
                        >
                            <i class="fas fa-chevron-left"></i>
                        </a>
                    <% } %>

                    <% 
                        let delta = 2; // Menampilkan 2 halaman di kiri dan 2 di kanan active page
                        let left = parseInt(currentPage) - delta;
                        let right = parseInt(currentPage) + delta;
                        let range = [];
                        let rangeWithDots = [];
                        let l;

                        for (let i = 1; i <= totalPages; i++) {
                            if (i == 1 || i == totalPages || (i >= left && i <= right)) {
                                range.push(i);
                            }
                        }

                        for (let i of range) {
                            if (l) {
                                if (i - l === 2) {
                                    rangeWithDots.push(l + 1);
                                } else if (i - l !== 1) {
                                    rangeWithDots.push('...');
                                }
                            }
                            rangeWithDots.push(i);
                            l = i;
                        }
                    %>

                    <% rangeWithDots.forEach(i => { %>
                        <% if (i === '...') { %>
                            <span class="px-3 py-1 text-gray-400">...</span>
                        <% } else { %>
                            <a 
                                href="/search?q=<%= query.q %>&searchBy=<%= query.searchBy %>&matchType=<%= query.matchType %>&category=<%= query.category %>&subject=<%= query.subject %>&year=<%= query.year %>&page=<%= i %>"
                                class="px-3 py-1 border rounded text-sm transition-colors <%= currentPage == i ? 'bg-blue-600 text-white border-blue-600 font-bold' : 'bg-white text-gray-600 hover:bg-blue-50' %>">
                                <%= i %>
                            </a>
                        <% } %>
                    <% }) %>

                    <% if (currentPage < totalPages) { %>
                        <a
                            href="/search?q=<%= query.q %>&searchBy=<%= query.searchBy %>&matchType=<%= query.matchType %>&category=<%= query.category %>&subject=<%= query.subject %>&year=<%= query.year %>&page=<%= parseInt(currentPage) + 1 %>"
                            class="px-3 py-1 border rounded text-sm bg-white text-gray-600 hover:bg-blue-50"
                        >
                            <i class="fas fa-chevron-right"></i>
                        </a>
                    <% } %>

                </div>
            <% } %>

        </main>
    </div>

    <script src="https://cdn.jsdelivr.net/npm/tom-select/dist/js/tom-select.complete.min.js"></script>
    <script>
        new TomSelect('#categorySelect', {
            allowEmptyOption: true,
            placeholder: "Pilih kategori...",
            dropdownClass: 'z-50 absolute tom-select-dropdown',
            dropdownParent: 'body',
            maxItems: 1,
            maxOptions: null,
            onInitialize: function() {
                this.control_input.style.minWidth = '0';
            }
        });
        
        new TomSelect('#subjectSelect', {
            allowEmptyOption: true,
            placeholder: "Pilih subjek...",
            dropdownClass: 'z-50 absolute tom-select-dropdown',
            dropdownParent: 'body',
            maxItems: 1,
            maxOptions: null,
            onInitialize: function() {
                this.control_input.style.minWidth = '0';
            }
        });
        
        new TomSelect('#yearSelect', {
            allowEmptyOption: true,
            placeholder: "Pilih tahun...",
            dropdownClass: 'z-50 absolute tom-select-dropdown',
            dropdownParent: 'body',
            maxItems: 1,
            maxOptions: null,
            onInitialize: function() {
                this.control_input.style.minWidth = '0';
            }
        });
    </script>

    <style>
        .ts-control {
            border: 1px solid #d1d5db !important; 
            border-radius: 0.5rem !important;    
            padding: 0.5rem 0.75rem !important;
            background-color: #ffffff !important;
        }
        .ts-wrapper.focus .ts-control {
            border-color: #3b82f6 !important;    
            box-shadow: 0 0 0 2px rgba(59, 130, 246, 0.2) !important;
        }
        .tom-select-dropdown {
            border-radius: 0.5rem !important;
            margin-top: 4px !important;
            box-shadow: 0 10px 15px -3px rgba(0, 0, 0, 0.1) !important;
        }
    </style>

</div>

<%- include('partials/footer') %>